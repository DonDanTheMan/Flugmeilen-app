<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Flugmeilen Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111827" />
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

<!-- Wichtig f√ºr Android: -->
<meta name="theme-color" content="#111827">


  <!-- Leaflet f√ºr die Karte -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111827;
      background: #0b1120;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #1f2937, #020617);
      min-height: 100vh;
      color: #e5e7eb;
    }
    header {
      padding: 0.9rem 1.2rem 0.6rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }
    header small {
      color: #9ca3af;
      font-size: 0.75rem;
    }
    main {
      max-width: 900px;
      margin: 0 auto 2rem;
      padding: 0 0.75rem 1.5rem;
    }
    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 0.9rem;
      padding: 0.9rem 0.9rem 0.9rem;
      box-shadow: 0 18px 50px rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.2);
      margin-bottom: 0.9rem;
      backdrop-filter: blur(14px);
    }
    .card h2 {
      margin: 0 0 0.4rem;
      font-size: 1rem;
    }
    .muted {
      color: #9ca3af;
      font-size: 0.8rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.4rem 0.6rem;
      margin-top: 0.4rem;
    }
    label {
      display: block;
      font-size: 0.78rem;
      margin-bottom: 0.15rem;
      color: #9ca3af;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.35rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 0.82rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: none;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.15s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg,#2563eb,#7c3aed);
      color: #f9fafb;
      box-shadow: 0 8px 18px rgba(37,99,235,0.5);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(37,99,235,0.6);
    }
    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.6);
    }
    .btn-secondary:hover {
      background: rgba(30,64,175,0.7);
    }
    .btn-sm { padding: 0.2rem 0.6rem; font-size: 0.76rem; }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .pill {
      border-radius: 999px;
      padding: 0.05rem 0.5rem;
      font-size: 0.75rem;
      background: rgba(30,64,175,0.7);
      color: #e5e7eb;
      border: 1px solid rgba(191,219,254,0.7);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(120px,1fr));
      gap: 0.4rem;
      margin-top: 0.4rem;
    }
    .stat-card {
      background: rgba(15,23,42,0.9);
      border-radius: 0.8rem;
      padding: 0.4rem 0.6rem;
      border: 1px solid rgba(148,163,184,0.35);
    }
    .stat-label {
      font-size: 0.72rem;
      color: #9ca3af;
    }
    .stat-value {
      font-size: 0.95rem;
      margin-top: 0.1rem;
    }
    .stat-note {
      font-size: 0.7rem;
      color: #6b7280;
    }
    .badge {
      border-radius: 999px;
      padding: 0.05rem 0.4rem;
      font-size: 0.72rem;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
    }
    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      border-radius: 0.8rem;
      border: 1px solid rgba(148,163,184,0.5);
      margin-top: 0.4rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
    th, td {
      padding: 0.35rem 0.4rem;
      text-align: left;
      border-bottom: 1px solid rgba(55,65,81,0.8);
      vertical-align: top;
    }
    th {
      position: sticky;
      top: 0;
      background: rgba(15,23,42,0.97);
      z-index: 1;
      text-transform: uppercase;
      font-size: 0.7rem;
      color: #9ca3af;
      letter-spacing: 0.04em;
    }
    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.85);
    }
    .tag {
      border-radius: 999px;
      padding: 0.05rem 0.4rem;
      font-size: 0.72rem;
      border: 1px solid rgba(129,140,248,0.8);
      background: rgba(30,64,175,0.5);
      color: #e5e7eb;
    }
    .error {
      color: #fecaca;
      font-size: 0.78rem;
      margin-top: 0.25rem;
    }
    input[type="file"] {
      font-size: 0.75rem;
    }
    .flex-row {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .nav-bar {
      display:flex;
      gap:0.6rem;
      padding:0.3rem 1rem 0.6rem;
      max-width:900px;
      margin:0 auto;
    }
    .nav-active {
      background: linear-gradient(135deg,#2563eb,#7c3aed);
      color:#f9fafb;
      box-shadow:0 8px 18px rgba(37,99,235,0.5);
      border-color:transparent;
    }
    @media (max-width: 480px) {
      header { flex-direction: column; align-items: flex-start; }
      .table-wrapper { max-height: 300px; }
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Flugmeilen</h1>
    <small>Lokale Web-App &ndash; Daten bleiben auf dem Ger&auml;t</small>
  </div>
  <div class="flex-row">
    <select id="yearSelect" class="badge"></select>
    <button id="resetYearBtn" class="btn btn-secondary btn-sm" type="button">Alle Jahre</button>
  </div>
</header>

<nav class="nav-bar">
  <button id="tabMain"   class="btn btn-secondary btn-sm nav-active">Fl&uuml;ge</button>
  <button id="tabStats"  class="btn btn-secondary btn-sm">Statistik</button>
</nav>

<!-- Seite 1: Fl√ºge / Eingabe -->
<main id="mainPage">
  <!-- Airport Import -->
  <section class="card">
    <div class="toolbar">
      <div>
        <h2>Flughafen-Daten</h2>
        <div class="muted">CSV mit IATA, Stadt, Breite, L&auml;nge aus deinem Excelblatt <b>FlughafenDaten</b> importieren.</div>
      </div>
      <span id="airportCount" class="badge">0 Airports</span>
    </div>
    <div class="form-grid" style="margin-top:0.5rem;">
      <div>
        <label for="airportFile">airports.csv w&auml;hlen</label>
        <input type="file" id="airportFile" accept=".csv,text/csv" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="loadAirportBtn" class="btn btn-secondary btn-sm" type="button">CSV laden</button>
      </div>
      <div style="grid-column:1/-1">
        <div class="muted">
          Erwartete Spaltennamen: <span class="pill">IATA</span>,
          <span class="pill">Stadt</span>,
          <span class="pill">Breite</span>,
          <span class="pill">L&auml;nge</span> (Trennzeichen ; oder ,).
        </div>
      </div>
    </div>
    <div id="airportError" class="error"></div>
  </section>

  <!-- Fl√ºge aus Excel-CSV importieren -->
  <section class="card">
    <div class="toolbar">
      <div>
        <h2>Fl&uuml;ge aus Excel-CSV importieren</h2>
        <div class="muted">
          Pro Jahr ein CSV (z.B. <code>flights_2014.csv</code>) mit Spalten
          <span class="pill">Datum</span>,
          <span class="pill">Von-IATA</span>,
          <span class="pill">Nach-IATA</span>,
          <span class="pill">Airline</span>,
          <span class="pill">Aircraft</span>,
          <span class="pill">Typ (p/g)</span>.
          IATA steht dabei wie in Excel als <code>Z&uuml;rich (ZRH)</code>.
        </div>
      </div>
      <span id="flightImportInfo" class="badge"></span>
    </div>
    <div class="form-grid" style="margin-top:0.5rem;">
      <div>
        <label for="flightsFile">flights_YYYY.csv w&auml;hlen</label>
        <input type="file" id="flightsFile" accept=".csv,text/csv" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="loadFlightsBtn" class="btn btn-secondary btn-sm" type="button">
          Fl&uuml;ge laden
        </button>
      </div>
    </div>
    <div id="flightsImportError" class="error"></div>
  </section>

  <!-- √úbersicht -->
  <section class="card">
    <div class="toolbar">
      <h2>&Uuml;bersicht <span id="summaryYearLabel" class="pill"></span></h2>
      <div class="flex-row">
        <span id="flightCountLabel" class="badge">0 Fl&uuml;ge</span>
      </div>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Miles (Filter)</div>
        <div id="statMiles" class="stat-value">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Km (Filter)</div>
        <div id="statKm" class="stat-value">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Flugzeit (Filter)</div>
        <div id="statHours" class="stat-value">‚Äì</div>
        <div id="statHoursText" class="stat-note"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Fl&uuml;ge p / g (Filter)</div>
        <div id="statPg" class="stat-value">‚Äì</div>
        <div id="statPgNote" class="stat-note">p = privat, g = gesch&auml;ftlich</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Airlines (Filter)</div>
        <div id="statAirlines" class="stat-value">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Aircrafts (Filter)</div>
        <div id="statAircrafts" class="stat-value">‚Äì</div>
      </div>
    </div>
  </section>

  <!-- Mini-Statistik -->
  <section class="card">
    <h2>Mini-Statistik (Filter)</h2>
    <div id="miniStats" class="stats-grid"></div>
  </section>

  <!-- Flug hinzuf√ºgen -->
  <section class="card">
    <h2>Neuen Flug hinzuf&uuml;gen</h2>
    <div class="form-grid">
      <div>
        <label for="flightDate">Datum</label>
        <input type="date" id="flightDate" />
      </div>
      <div>
        <label for="fromIata">Von (IATA)</label>
        <input type="text" id="fromIata" maxlength="3" placeholder="ZRH" />
      </div>
      <div>
        <label for="toIata">Nach (IATA)</label>
        <input type="text" id="toIata" maxlength="3" placeholder="CUN" />
      </div>
      <div>
        <label for="airline">Airline</label>
        <input type="text" id="airline" placeholder="Swiss" />
      </div>
      <div>
        <label for="aircraft">Flugzeugtyp</label>
        <input type="text" id="aircraft" placeholder="Airbus A320" />
      </div>
      <div>
        <label for="tripType">Privat / Gesch&auml;ft</label>
        <select id="tripType">
          <option value="p">Privat</option>
          <option value="g">Gesch&auml;ft</option>
        </select>
      </div>
      <div>
        <label for="speed">√ò Reisegeschwindigkeit [km/h]</label>
        <input type="number" id="speed" value="600" min="300" max="1000" step="10" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="addFlightBtn" class="btn btn-primary" type="button">+ Flug speichern</button>
      </div>
    </div>
    <div id="flightError" class="error"></div>
  </section>

  <!-- Fl√ºge Tabelle -->
  <section class="card">
    <div class="toolbar">
      <div class="flex-row">
        <h2 style="margin:0;">Fl&uuml;ge</h2>
        <span id="visibleCount" class="badge">0 sichtbar</span>
      </div>
      <div class="flex-row">
        <input type="search" id="searchInput" placeholder="Suche (IATA, Stadt, Airline)" />
        <button id="clearAllFlightsBtn" class="btn btn-secondary btn-sm" type="button">Alle l&ouml;schen</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>#</th>
          <th>Datum</th>
          <th>Von</th>
          <th>Nach</th>
          <th>Airline</th>
          <th>Aircraft</th>
          <th>Distanz</th>
          <th>Dauer</th>
          <th>p/g</th>
          <th></th>
        </tr>
        </thead>
        <tbody id="flightTableBody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Seite 2: Statistik -->
<main id="statsPage" style="display:none;">
  <section class="card">
    <h2>üìä Gesamtstatistik (alle Fl&uuml;ge)</h2>
    <div id="statsAllYears" class="stats-grid"></div>
  </section>

  <section class="card">
    <h2>üìÖ Statistik f&uuml;r gew&auml;hltes Jahr</h2>
    <div id="statsSelectedYear" class="stats-grid"></div>
  </section>

  <section class="card">
    <h2>üåç Weltkarte aller Fl&uuml;ge (gew&auml;hltes Jahr / Filter)</h2>
    <div id="map" style="height:350px; border-radius:12px;"></div>
  </section>

  <section class="card">
    <h2>‚úà Flugh&auml;fen</h2>
    <div id="statsAirports"></div>
  </section>

  <section class="card">
    <h2>üõ´ Airlines</h2>
    <div id="statsAirlines"></div>
  </section>

  <section class="card">
    <h2>üõ© Flugzeugtypen</h2>
    <div id="statsAircrafts"></div>
  </section>

  <section class="card">
    <h2>üèÜ Top 5</h2>
    <div class="form-grid">
      <div>
        <h3>Flugh&auml;fen</h3>
        <div id="topAirports"></div>
      </div>
      <div>
        <h3>Airlines</h3>
        <div id="topAirlines"></div>
      </div>
      <div>
        <h3>Flugzeugtypen</h3>
        <div id="topAircrafts"></div>
      </div>
    </div>
  </section>
</main>

<script>
const STORAGE_KEY_FLIGHTS = "flugmeilen_flights_v3";
const STORAGE_KEY_AIRPORTS = "flugmeilen_airports_v3";

let AIRPORTS = loadAirportsFromStorage();
let leafletMap = null;
let editingId = null;

// --- Storage ---
function loadAirportsFromStorage() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY_AIRPORTS)) || {};
  } catch (_) {
    return {};
  }
}
function saveAirportsToStorage() {
  localStorage.setItem(STORAGE_KEY_AIRPORTS, JSON.stringify(AIRPORTS));
}
function loadFlights() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY_FLIGHTS)) || [];
  } catch (_) {
    return [];
  }
}
function saveFlights(f) {
  localStorage.setItem(STORAGE_KEY_FLIGHTS, JSON.stringify(f));
}

// --- Mathe/Format ---
function deg2rad(d){return d*Math.PI/180;}
function calcDistanceKm(from,to){
  const a=AIRPORTS[from],b=AIRPORTS[to];
  if(!a||!b) return null;
  const R=6371;
  const dlat=deg2rad(b.lat-a.lat),dlon=deg2rad(b.lon-a.lon);
  const h=Math.sin(dlat/2)**2+Math.cos(deg2rad(a.lat))*Math.cos(deg2rad(b.lat))*Math.sin(dlon/2)**2;
  return R*2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}
function calcDurationHours(dist,spd){return dist&&spd?dist/spd+0.5:null;}
function formatKm(v){return v? v.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,"'")+" km":"‚Äì";}
function formatMiles(v){return v? (v*0.621371).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,"'")+" mi":"‚Äì";}
function formatHours(h){if(!h)return"‚Äì";const m=Math.round(h*60),H=Math.floor(m/60),M=m%60;return`${String(H).padStart(2,"0")}:${String(M).padStart(2,"0")} h`;}
function hoursToText(h){if(!h)return"";return"";}
function formatDate(d){const x=new Date(d);return isNaN(x)?d:x.toLocaleDateString();}

// --- Airport Import ---
function parseCsvAirports(t){
  const l=t.split(/\r?\n/).filter(r=>r.trim());
  const d=l[0].includes(";")?";":",";
  const h=l[0].split(d).map(x=>x.trim().toLowerCase());
  const iI=h.indexOf("iata"),iC=h.indexOf("stadt"),iLa=h.indexOf("breite"),iLo=h.indexOf("l√§nge")>=0?h.indexOf("l√§nge"):h.indexOf("laenge");
  if(iI<0||iC<0||iLa<0||iLo<0) throw Error("Spalten fehlen");
  const r={};
  for(let i=1;i<l.length;i++){
    const p=l[i].split(d);const c=(p[iI]||"").trim().toUpperCase();
    if(c.length!==3)continue;
    const city=(p[iC]||"").trim();
    const lat=parseFloat((p[iLa]||"").replace(",","."));
    const lon=parseFloat((p[iLo]||"").replace(",","."));
    if(!isFinite(lat)||!isFinite(lon))continue;
    r[c]={city,lat,lon};
  }
  return r;
}
function handleAirportCsvLoad(){
  const f=document.getElementById("airportFile").files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    try{
      AIRPORTS=parseCsvAirports(e.target.result);
      saveAirportsToStorage();updateAirportCount();renderAll();
    }catch(err){alert(err.message);}
  };
  r.readAsText(f,"windows-1252");
}
function updateAirportCount(){
  const n=Object.keys(AIRPORTS).length;
  document.getElementById("airportCount").textContent= n+" Airports";
}

// --- Flights manuell ---
function addFlight(){
  const date=flightDate.value;
  const from=fromIata.value.trim().toUpperCase();
  const to=toIata.value.trim().toUpperCase();
  const airline=airlineEl.value.trim();
  const aircraft=aircraftEl.value.trim();
  const tripType=tripTypeEl.value;
  const speed=+speedEl.value;

  if(!AIRPORTS[from]||!AIRPORTS[to]){alert("Unbekannte IATA");return;}

  const dist=calcDistanceKm(from,to);
  const dur=calcDurationHours(dist,speed);
  const f=loadFlights();
  const o={
    id:editingId||Date.now(),
    date,from,to,airline,aircraft,tripType,
    speedKmh:speed,distanceKm:dist,durationHours:dur
  };
  if(editingId){
    const i=f.findIndex(x=>x.id===editingId);
    f[i]=o;
    editingId=null;addFlightBtn.textContent="+ Flug speichern";
  } else f.push(o);

  saveFlights(f);renderAll();
}
function deleteFlight(id){
  saveFlights(loadFlights().filter(x=>x.id!=id));
  if(editingId==id){editingId=null;addFlightBtn.textContent="+ Flug speichern";}
  renderAll();
}
function startEditFlight(id){
  const f=loadFlights().find(x=>x.id==id);
  if(!f)return;
  editingId=f.id;
  flightDate.value=f.date;
  fromIata.value=f.from;
  toIata.value=f.to;
  airlineEl.value=f.airline;
  aircraftEl.value=f.aircraft;
  tripTypeEl.value=f.tripType;
  speedEl.value=f.speedKmh;
  addFlightBtn.textContent="√Ñnderungen speichern";
}

// --- Search / Filter ---
function getSelectedYear(){const v=yearSelect.value;return v?+v:null;}
function buildYearOptions(f){
  const s=new Set(f.map(x=>new Date(x.date).getFullYear()));
  const el=yearSelect;el.innerHTML="<option value=''>Alle Jahre</option>";
  [...s].sort().forEach(y=>el.innerHTML+=`<option>${y}</option>`);
}
function applyFilters(f){
  const y=getSelectedYear();
  const q=searchInput.value.trim().toLowerCase();
  return f.filter(x=>{
    const d=new Date(x.date).getFullYear();
    if(y && d!==y) return false;
    if(q){
      const a=AIRPORTS[x.from]||{},b=AIRPORTS[x.to]||{};
      const inTxt=[x.from,x.to,a.city,b.city,x.airline,x.aircraft].join(" ").toLowerCase();
      if(!inTxt.includes(q)) return false;
    }
    return true;
  });
}

// --- Statistik ---
function countOcc(arr,fn){const o={};arr.forEach(x=>{const k=fn(x);if(k)o[k]=(o[k]||0)+1});return o;}
function sortedEntries(o){return Object.entries(o).sort((a,b)=>b[1]-a[1]);}
function buildStatsTable(e){
  if(!e.length)return"<span class='muted'>Keine Daten</span>";
  return"<table><tbody>"+e.map(x=>`<tr><td>${x[0]}</td><td style='text-align:right'>${x[1]}</td></tr>`).join("")+"</tbody></table>";
}

function renderFullStatistics(){
  const f=loadFlights();
  const y=getSelectedYear();
  const fy=y?f.filter(x=>new Date(x.date).getFullYear()==y):f;

  // Visits
  const from=countOcc(fy,x=>`${AIRPORTS[x.from]?.city||x.from} (${x.from})`);
  const to=countOcc(fy,x=>`${AIRPORTS[x.to]?.city||x.to} (${x.to})`);
  const moves={};
  for(const[k,v]of Object.entries(from))moves[k]=(moves[k]||0)+v;
  for(const[k,v]of Object.entries(to))moves[k]=(moves[k]||0)+v;
  const visits={};
  for(const[k,v]of Object.entries(moves))visits[k]=Math.ceil(v/2);
  const sortedAirports=sortedEntries(visits);

  document.getElementById("statsAirports").innerHTML=buildStatsTable(sortedAirports);
  document.getElementById("topAirports").innerHTML=buildStatsTable(sortedAirports.slice(0,5));

  setTimeout(()=>renderMap(fy),100);
}

// --- Karte ---
function renderMap(f){
  if(!document.getElementById("map"))return;
  if(leafletMap)leafletMap.remove();
  leafletMap=L.map("map").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:8}).addTo(leafletMap);
  const c=new Set();
  f.forEach(x=>{if(AIRPORTS[x.from])c.add(x.from);if(AIRPORTS[x.to])c.add(x.to);});
  const b=[];
  c.forEach(i=>{
    const a=AIRPORTS[i];
    const ll=[a.lat,a.lon];
    L.marker(ll).addTo(leafletMap).bindPopup(`${a.city} (${i})`);
    b.push(ll);
  });
  if(b.length)leafletMap.fitBounds(b,{padding:[20,20]});
}

// --- Table ---
function renderFlightsTable(f){
  flightTableBody.innerHTML = "";
  f.forEach((x,i)=>{
    const a=AIRPORTS[x.from]||{},b=AIRPORTS[x.to]||{};
    flightTableBody.innerHTML+=`
    <tr><td>${i+1}</td>
    <td>${formatDate(x.date)}</td>
    <td>${x.from}<br><span class='muted'>${a.city||""}</span></td>
    <td>${x.to}<br><span class='muted'>${b.city||""}</span></td>
    <td>${x.airline}</td>
    <td>${x.aircraft}</td>
    <td>${formatKm(x.distanceKm)}<br><span class='muted'>${formatMiles(x.distanceKm)}</span></td>
    <td>${formatHours(x.durationHours)}</td>
    <td>${x.tripType}</td>
    <td>
      <button data-edit='${x.id}' class='btn btn-secondary btn-sm'>‚úé</button>
      <button data-del='${x.id}' class='btn btn-secondary btn-sm'>‚úï</button>
    </td></tr>`;
  });
  [...flightTableBody.querySelectorAll("[data-edit]")].forEach(b=>b.onclick=()=>startEditFlight(b.dataset.edit));
  [...flightTableBody.querySelectorAll("[data-del]")].forEach(b=>b.onclick=()=>deleteFlight(b.dataset.del));
}

// --- Render ALL ---
function renderAll(){
  updateAirportCount();
  const f=loadFlights();
  buildYearOptions(f);
  const v=applyFilters(f);
  renderFlightsTable(v);
  if(statsPage.style.display!="none")renderFullStatistics();
}

// --- Init ---
const flightDate=document.getElementById("flightDate");
const fromIata=document.getElementById("fromIata");
const toIata=document.getElementById("toIata");
const airlineEl=document.getElementById("airline");
const aircraftEl=document.getElementById("aircraft");
const tripTypeEl=document.getElementById("tripType");
const speedEl=document.getElementById("speed");
const addFlightBtn=document.getElementById("addFlightBtn");

document.getElementById("loadAirportBtn").onclick=handleAirportCsvLoad;
document.getElementById("addFlightBtn").onclick=addFlight;
document.getElementById("searchInput").oninput=renderAll;
document.getElementById("yearSelect").onchange=renderAll;
document.getElementById("resetYearBtn").onclick=()=>{yearSelect.value="";renderAll();};
document.getElementById("clearAllFlightsBtn").onclick=()=>{if(confirm("Alle l√∂schen?")){localStorage.removeItem(STORAGE_KEY_FLIGHTS);renderAll();}};
document.getElementById("tabMain").onclick=()=>{mainPage.style.display="block";statsPage.style.display="none";renderAll();}
document.getElementById("tabStats").onclick=()=>{mainPage.style.display="none";statsPage.style.display="block";renderFullStatistics();}

renderAll();
</script>
</body>
</html>
