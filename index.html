<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Flugmeilen Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#020617" />
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <!-- Leaflet MarkerCluster Plugin -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  color: #e5e7eb;
  --accent: #06b6d4;
  --bg-dark: #020617;
}

    body {
      margin: 0;
      min-height: 100vh;
      color: #e5e7eb;
      /* Radar- / Grid-Style Hintergrund */
      background-color: #020617;
      background-image:
        radial-gradient(circle at top, rgba(34,197,94,0.25), transparent 55%),
        linear-gradient(rgba(15,23,42,0.9), rgba(15,23,42,0.95)),
        linear-gradient(transparent 23px, rgba(15,23,42,0.9) 24px),
        linear-gradient(90deg, transparent 23px, rgba(15,23,42,0.9) 24px);
      background-size:
        100% 100%,
        100% 100%,
        24px 24px,
        24px 24px;
      background-position: 0 0, 0 0, 0 0, 0 0;
    }
	
	body { padding-bottom: 3.2rem; }

    header {
      padding: 0.9rem 1.2rem 0.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 1px solid rgba(34,197,94,0.4);
      backdrop-filter: blur(16px);
      background: radial-gradient(circle at top left, rgba(34,197,94,0.16), rgba(15,23,42,0.95));
      box-shadow: 0 14px 40px rgba(0,0,0,0.8);
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.45rem;
      color: #a7f3d0;
      text-shadow:
        0 0 8px rgba(34,197,94,0.6),
        0 0 18px rgba(56,189,248,0.7);
    }

    header h1 span.icon {
      font-size: 1.5rem;
    }

    header small {
      color: #9ca3af;
      font-size: 0.75rem;
    }

    main {
      max-width: 900px;
      margin: 0.4rem auto 2rem;
      padding: 0 0.75rem 1.5rem;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(45,212,191,0.04), rgba(15,23,42,0.96));
      border-radius: 1rem;
      padding: 0.9rem;
      box-shadow:
        0 20px 60px rgba(0,0,0,0.9),
        0 0 0 1px rgba(15,23,42,0.9);
      border: 1px solid rgba(75,85,99,0.9);
      margin-bottom: 0.9rem;
      backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      border: 1px solid rgba(34,197,94,0.07);
      pointer-events: none;
    }

    .card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.05rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      color: #e5e7eb;
    }

    .card h2 span.icon {
      font-size: 1rem;
      color: #6ee7b7;
      text-shadow: 0 0 10px rgba(34,197,94,0.8);
    }

    .muted {
      color: #9ca3af;
      font-size: 0.8rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.5rem 0.7rem;
      margin-top: 0.4rem;
    }

    label {
      display: block;
      font-size: 0.78rem;
      margin-bottom: 0.15rem;
      color: #9ca3af;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.35rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95), #020617);
      color: #e5e7eb;
      font-size: 0.82rem;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input:focus, select:focus {
      border-color: rgba(56,189,248,0.9);
      box-shadow:
        0 0 0 1px rgba(56,189,248,0.7),
        0 0 18px rgba(34,197,94,0.4);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9), #020617);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      border: none;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      gap: 0.25rem;
      transition:
        transform 0.05s ease,
        box-shadow 0.12s ease,
        background 0.15s ease,
        border 0.15s ease;
    }

    .btn span.icon {
      font-size: 0.9rem;
    }

    .btn-primary {
      background: radial-gradient(circle at top left, #22d3ee, #16a34a);
      color: #0b1120;
      box-shadow: 0 12px 30px rgba(34,197,94,0.65);
      border: 1px solid rgba(34,197,94,0.7);
      text-shadow: 0 0 6px rgba(15,23,42,0.4);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(22,163,74,0.9);
    }

    .btn-secondary {
      background: radial-gradient(circle at top left, #020617, #020617);
      color: #e5e7eb;
      border: 1px solid rgba(75,85,99,0.9);
      box-shadow: 0 6px 20px rgba(0,0,0,0.8);
    }

    .btn-secondary:hover {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-color: rgba(56,189,248,0.8);
      box-shadow: 0 10px 28px rgba(15,23,42,0.9);
    }

    .btn-warning {
      background: radial-gradient(circle at top left, #22c55e, #eab308);
      color: #111827;
      border-color: rgba(250,204,21,0.9);
      box-shadow: 0 12px 32px rgba(250,204,21,0.6);
      text-shadow: 0 0 6px rgba(15,23,42,0.6);
    }

    .btn-warning:hover {
      box-shadow: 0 16px 38px rgba(234,179,8,0.8);
    }

    .btn-sm { padding: 0.2rem 0.6rem; font-size: 0.76rem; }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .pill {
      border-radius: 999px;
      padding: 0.1rem 0.6rem;
      font-size: 0.75rem;
      background: rgba(8,47,73,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(56,189,248,0.6);
    }

    .pill-soft {
      background: rgba(15,23,42,0.9);
      border-color: rgba(75,85,99,1);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(120px,1fr));
      gap: 0.4rem;
      margin-top: 0.4rem;
    }
	
.highlight-title {
  font-size: 0.85rem;
  color: #e5e7eb;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 0.35rem;
}

.highlight-title .icon {
  font-size: 1.1rem;
}

.highlight-main {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.15rem;
}

.highlight-sub {
  font-size: 0.78rem;
  color: #9ca3af;
}


.dashboard-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  padding: 1rem 1.2rem;
  margin-bottom: 1rem;
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.dashboard-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.35);
}

.dashboard-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.4rem;
  display: flex;
  align-items: center;
  gap: 0.45rem;
}

.dashboard-title .icon {
  font-size: 1.3rem;
}

.dashboard-value {
  font-size: 1.8rem;
  font-weight: 700;
  margin-top: 0.4rem;
}

/* Untere Detailkarten im gleichen Stil wie der Rest (neon / radar) */
#dashboardPage .detail-card {
  background:
    radial-gradient(circle at top left, rgba(34,197,94,0.12), rgba(15,23,42,0.98));
  border-radius: 1rem;
  border: 1px solid rgba(74,222,128,0.35);
  box-shadow:
    0 0 0 1px rgba(15,23,42,1),
    0 1px 4px rgba(16,185,129,0.35);
  padding: 0.85rem 1.1rem;
}

/* Titel wie beim Rest: klein, uppercase, mit Icon */
#dashboardPage .detail-card h2 {
  margin: 0 0 0.4rem;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  display: flex;
  align-items: center;
  gap: 0.35rem;
  color: #bbf7d0;
}

/* Route fett & groÃŸ â€“ Ã¤hnlich wie KPI-Zahlen */
#dashboardPage #dashLongestRoute,
#dashboardPage #dashShortestRoute,
#dashboardPage #dashMostRoute {
  font-size: 1.6rem;
  font-weight: 600;
  margin-bottom: 0.2rem;
}

/* Beschreibung (StÃ¤dte + Distanz/Zeit) optisch an KPI-Subtext anpassen */
#dashboardPage #dashLongestDesc,
#dashboardPage #dashShortestDesc,
#dashboardPage #dashMostRouteCount {
  font-size: 0.78rem;
  color: #cbd5f5;
}

/* Die StÃ¤dte-Zeile etwas dezenter */
#dashboardPage .city-line {
  font-size: 0.8rem;
  color: #9ca3af;
  margin-bottom: 2px;
}

    .stat-card {
      background: radial-gradient(circle at top left, rgba(22,163,74,0.04), rgba(15,23,42,0.96));
      border-radius: 0.8rem;
      padding: 0.4rem 0.6rem;
      border: 1px solid rgba(55,65,81,0.95);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      border: 1px solid rgba(56,189,248,0.08);
      pointer-events: none;
    }

    .stat-label {
      font-size: 0.72rem;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .stat-label span.icon {
      font-size: 0.85rem;
      color: #6ee7b7;
      text-shadow: 0 0 8px rgba(34,197,94,0.9);
    }

    .stat-value {
      font-size: 1.05rem;
      margin-top: 0.1rem;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #e5e7eb;
    }

    .stat-note {
      font-size: 0.7rem;
      color: #64748b;
    }

    .badge {
      border-radius: 999px;
      padding: 0.05rem 0.5rem;
      font-size: 0.75rem;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(56,189,248,0.7);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .badge span.icon {
      color: #22c55e;
    }

    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      border-radius: 0.8rem;
      border: 1px solid rgba(55,65,81,1);
      margin-top: 0.4rem;
      box-shadow: inset 0 0 0 1px rgba(15,23,42,0.8);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    th, td {
      padding: 0.35rem 0.4rem;
      text-align: left;
      border-bottom: 1px solid rgba(31,41,55,1);
      vertical-align: top;
    }

    th {
      position: sticky;
      top: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,1), rgba(2,6,23,1));
      z-index: 1;
      text-transform: uppercase;
      font-size: 0.7rem;
      color: #9ca3af;
      letter-spacing: 0.08em;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.96);
    }

    tbody tr:nth-child(odd) {
      background: rgba(2,6,23,0.96);
    }

    tbody tr:hover {
      background: radial-gradient(circle at left, rgba(34,197,94,0.18), rgba(15,23,42,0.98));
    }

    table td:first-child,
    table th:first-child {
      width: 2.5rem;
      text-align: right;
      color: #6b7280;
    }

    table td:nth-child(2),
    table th:nth-child(2) {
      width: 6rem;
    }

    .tag {
      border-radius: 999px;
      padding: 0.05rem 0.4rem;
      font-size: 0.72rem;
      border: 1px solid rgba(56,189,248,0.9);
      background: radial-gradient(circle at top left, rgba(15,23,42,1), rgba(15,23,42,1));
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .tag span.icon {
      font-size: 0.85rem;
      color: #2dd4bf;
    }

    .trip-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.05rem 0.45rem;
      border-radius: 999px;
      font-size: 0.72rem;
      border: 1px solid rgba(75,85,99,1);
      background: radial-gradient(circle at top left, #020617, #020617);
    }

    .trip-badge span.icon {
      font-size: 0.85rem;
    }

    .trip-privat {
      border-color: rgba(34,197,94,0.9);
      background: radial-gradient(circle at top left, rgba(22,163,74,0.8), rgba(5,46,22,0.9));
      color: #ecfdf5;
    }

    .trip-geschaeft {
      border-color: rgba(234,179,8,0.9);
      background: radial-gradient(circle at top left, rgba(133,77,14,0.9), rgba(30,64,175,0.9));
      color: #fefce8;
    }

    .error {
      color: #fecaca;
      font-size: 0.78rem;
      margin-top: 0.25rem;
    }

    input[type="file"] {
      font-size: 0.75rem;
    }

    .flex-row {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .nav-bar {
      display:flex;
      gap:0.6rem;
      padding:0.3rem 1rem 0.7rem;
      max-width:900px;
      margin:0 auto 0.4rem;
    }

    .nav-btn {
      flex:1;
      justify-content:center;
      background: radial-gradient(circle at top left, #020617, #020617);
      border:1px solid rgba(55,65,81,1);
      color:#e5e7eb;
      border-radius:999px;
      padding:0.35rem 0.5rem;
      font-size:0.8rem;
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
    }

    .nav-btn span.icon {
      font-size:0.95rem;
    }

    .nav-active {
      background: radial-gradient(circle at top left, #22d3ee, #16a34a);
      color:#020617;
      box-shadow:0 12px 34px rgba(34,197,94,0.75);
      border-color:transparent;
      text-shadow:0 0 6px rgba(15,23,42,0.7);
    }

    .edit-active {
      border-color: rgba(250,204,21,0.9);
      box-shadow:
        0 0 0 1px rgba(250,204,21,0.5),
        0 26px 70px rgba(0,0,0,1);
    }

    #map {
      background: radial-gradient(circle at center, rgba(15,23,42,1), #020617);
      box-shadow:
        0 16px 40px rgba(0,0,0,0.9),
        0 0 0 1px rgba(15,23,42,1);
    }

    @media (max-width: 480px) {
      header { flex-direction: column; align-items: flex-start; }
      .table-wrapper { max-height: 300px; }
      .nav-bar { padding:0.4rem 0.6rem 0.8rem; }
    }
/* =========================
   Bottom Nav â€“ App Style
   ========================= */

:root{
  --nav-h: 56px;                 /* Desktop/Tablet */
  --nav-h-mobile: 48px;          /* Phone */
  --nav-safe: env(safe-area-inset-bottom, 0px);
  --nav-bg: rgba(10, 16, 28, 0.78);
  --nav-border: rgba(148,163,184,0.22);
  --nav-text: #9ca3af;
  --nav-text-active: #e5e7eb;
  --nav-accent: rgba(56,189,248,0.95);
}

.bottom-nav{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;

  height: calc(var(--nav-h) + var(--nav-safe));
  padding-bottom: var(--nav-safe);

  display: flex;
  align-items: center;
  justify-content: space-around;
  gap: 4px;

  background: linear-gradient(180deg, rgba(10,16,28,0.65), var(--nav-bg));
  border-top: 1px solid var(--nav-border);

  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);

  z-index: 1000;
}

.bottom-nav .nav-item{
  flex: 1;
  height: var(--nav-h);

  border: 0;
  background: transparent;
  color: var(--nav-text);

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;

  padding: 6px 0 7px;
  gap: 2px;

  cursor: pointer;
  user-select: none;
  -webkit-tap-highlight-color: transparent;

  transition: color .15s ease, transform .08s ease, opacity .15s ease;
}

.bottom-nav .nav-icon{
  font-size: 18px;     /* kompakt, aber gut tappbar */
  line-height: 1;
  opacity: .95;
}

.bottom-nav .nav-label{
  font-size: 10px;     /* App-typisch */
  letter-spacing: .08em;
  text-transform: uppercase;
  opacity: .85;
}

.bottom-nav .nav-item.nav-active{
  color: var(--nav-text-active);
}

.bottom-nav .nav-item.nav-active .nav-icon{
  transform: translateY(-1px);
}

/* Dezentere Active-Markierung: kleines Pill + kein fetter Glow */
.bottom-nav .nav-item.nav-active::after{
  content: "";
  width: 22px;
  height: 3px;
  border-radius: 999px;
  margin-top: 2px;
  background: var(--nav-accent);
  box-shadow: 0 0 10px rgba(56,189,248,0.35);
  opacity: .9;
}

.bottom-nav .nav-item:active{
  transform: scale(0.97);
}

/* Phone: nochmal schlanker */
@media (max-width: 600px){
  .bottom-nav{
    height: calc(var(--nav-h-mobile) + var(--nav-safe));
  }
  .bottom-nav .nav-item{
    height: var(--nav-h-mobile);
    padding: 5px 0 6px;
  }
  .bottom-nav .nav-icon{ font-size: 17px; }
  .bottom-nav .nav-label{
    font-size: 9px;
    letter-spacing: .07em;
  }
}

/* sehr kleine Phones: Labels ausblenden -> ultra appig */
@media (max-width: 420px){
  .bottom-nav .nav-label{ display:none; }
  .bottom-nav .nav-item{ gap: 0; }
  .bottom-nav .nav-icon{ font-size: 18px; }
}

body{
  padding-bottom: calc(var(--nav-h) + var(--nav-safe) + 10px);
}

@media (max-width: 600px){
  body{
    padding-bottom: calc(var(--nav-h-mobile) + var(--nav-safe) + 10px);
  }
}

main[id$="Page"] {
  opacity: 0;
  transform: translateY(6px) scale(0.99);
  pointer-events: none;
  transition:
    opacity 0.18s ease-out,
    transform 0.2s ease-out;
}

/* aktive Seite */
main[id$="Page"].page-active {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}

.city-line {
  font-size: 0.85rem;
  color: #94a3b8;
  margin-bottom: 4px;
}

/* âœ… Global: Emojis als normalen Text behandeln â€“ kein Glow, keine Filter */
.icon,
.nav-icon,
.stat-label .icon,
.stat-card .icon,
.bottom-nav .nav-icon,
h1 span,
h2 span,
h3 span {
  filter: none !important;
  text-shadow: none !important;
  box-shadow: none !important;
  color: inherit !important;
}

/* Einheitliche Emoji-GrÃ¶ÃŸe & Ausrichtung Ã¼berall */
.icon,
.nav-icon,
h1 span,
h2 span,
h3 span {
  font-size: 1.05em;
  line-height: 1;
}

/* ğŸŒ Global: Einheitliche Emoji-GrÃ¶ÃŸe im gesamten Projekt */
emoji, 
.icon, 
.nav-item, 
.stat-label span, 
.stat-card span, 
h1 span, 
h2 span, 
h3 span, 
button span, 
label span, 
.card span {
  font-size: 1.2em !important;   /* Einheitliche Emoji-GrÃ¶ÃŸe */
  line-height: 1 !important;
  vertical-align: middle !important;
  filter: none !important;
  text-shadow: none !important;
}

/* âœ… Highlight-Karten: gleiche GrÃ¶ÃŸe/Typo wie Detailcards */
#dashboardPage #highlightTopAirline,
#dashboardPage #highlightLastFlight {
  min-height: 86px;              /* gleiche "Wucht" wie LÃ¤ngster Flug */
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 0.25rem;
}

/* Hauptzeile (wie Route-Text) */
#dashboardPage #highlightTopAirline .highlight-main,
#dashboardPage #highlightLastFlight .highlight-main {
  font-size: 1.6rem;
  font-weight: 600;
  color: #e5e7eb;
  line-height: 1.1;
  margin: 0;
}

/* Subtext (wie city-line/desc) */
#dashboardPage #highlightTopAirline .highlight-sub,
#dashboardPage #highlightLastFlight .highlight-sub {
  font-size: 0.78rem;
  color: #cbd5f5;
  line-height: 1.25;
  margin: 0;
}

/* ============================= */
/* Dashboard Detail Cards â€“ Typo */
/* ============================= */

#dashboardPage .detail-card {
  display: flex;
  flex-direction: column;
  justify-content: center;
}

/* Hauptzeile: gleiche GrÃ¶ÃŸe/Farbe wie "GIG â†’ AMS" */
#dashboardPage .detail-main {
  font-size: 1.6rem;        /* IDENTISCH */
  font-weight: 600;
  color: #e5e7eb;
  line-height: 1.1;
  margin-bottom: 0.25rem;
}

/* StÃ¤dte / Zusatzinfos */
#dashboardPage .detail-sub {
  font-size: 0.78rem;       /* IDENTISCH */
  color: #9ca3af;           /* IDENTISCH */
  line-height: 1.3;
}

/* Meistgeflogene Airline â€“ groÃŸes Logo */
#dashboardPage .airline-hero {
  display: flex;
  align-items: center;
  gap: 0.6rem;
}

#dashboardPage .airline-hero img {
  height: 38px;        /* ğŸ”¥ deutlich grÃ¶ÃŸer */
  width: auto;
  object-fit: contain;
}

/* ğŸ”¥ Dashboard: ALLE Detailkarten-Titel identisch */
#dashboardPage .detail-card > h2 {
  font-size: 0.8rem !important;      /* exakt wie LÃ¤ngster Flug */
  font-weight: 600 !important;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #bbf7d0 !important;         /* identische Farbe */
  display: flex;
  align-items: center;
  gap: 0.45rem;
  margin-bottom: 0.4rem;
  text-shadow: none !important;
}

/* ğŸ›« Meistgeflogene Airline â€“ HERO Logo */
#dashboardPage .detail-card .airline-hero img {
  height: 42px !important;   /* deutlich grÃ¶ÃŸer */
  width: auto !important;
  max-height: none !important;
  object-fit: contain;
}

/* Dashboard: alle Detailcard-Titel absolut identisch */
#dashboardPage section.detail-card > h2 {
  margin: 0 0 0.45rem !important;
  font-size: 1.1rem !important;
  font-weight: 600 !important;
  color: #e5e7eb !important;      /* gleiche Titel-Farbe */
  text-transform: none !important; /* KEIN uppercase */
  letter-spacing: 0.02em !important;
  display: flex !important;
  align-items: center !important;
  gap: 0.5rem !important;
  opacity: 0.95;
}

/* Flights: Toolbar sticky, damit Suche/Buttons beim Scrollen bleiben */
#flightsPage .flights-toolbar {
  position: sticky;
  top: 0.65rem;              /* falls du einen Header hast, ggf. erhÃ¶hen */
  z-index: 50;
  background: rgba(15,23,42,0.75);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border: 1px solid rgba(148,163,184,0.18);
  border-radius: 0.9rem;
  padding: 0.45rem 0.6rem;
}

/* Damit die sticky Toolbar nicht am Card-Rand "klebt" */
#flightsPage .card .flights-toolbar {
  margin: -0.2rem 0 0.6rem;
}

/* Actions rechts kompakt & appig */
#flightsPage .row-actions {
  white-space: nowrap;
  text-align: right;
}

#flightsPage .action-btn {
  width: 30px;
  height: 30px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.35);
  background: rgba(15,23,42,0.65);
  color: #e5e7eb;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin-left: 6px;
  transition: transform 0.08s ease, background 0.15s ease, border-color 0.15s ease;
}

#flightsPage .action-btn:hover {
  background: rgba(56,189,248,0.12);
  border-color: rgba(56,189,248,0.45);
  transform: translateY(-1px);
}

#flightsPage .action-btn:active {
  transform: scale(0.95);
}

#flightsPage .action-btn.danger:hover {
  background: rgba(239,68,68,0.12);
  border-color: rgba(239,68,68,0.45);
}

/* Empty State */
#flightsPage .empty-state {
  margin-top: 0.8rem;
  padding: 0.9rem 1rem;
  border-radius: 0.9rem;
  border: 1px dashed rgba(148,163,184,0.35);
  background: rgba(15,23,42,0.55);
  color: #cbd5f5;
}

#flightsPage .empty-title {
  font-weight: 600;
  margin-bottom: 0.2rem;
}

#flightsPage .empty-actions {
  margin-top: 0.6rem;
  display: flex;
  gap: 0.4rem;
  flex-wrap: wrap;
}

@media (min-width: 1100px){
  main{
    max-width: 1180px;   /* war kleiner */
  }
}
@media (min-width: 1400px){
  main{
    max-width: 1320px;
  }
}

/* Stats: Ranking Bars */
#statsPage .rank-bars{ display:flex; flex-direction:column; gap:0.35rem; }
#statsPage .rank-row{
  display:grid;
  grid-template-columns: 1fr auto;
  gap:0.6rem;
  align-items:center;
  padding:0.35rem 0.5rem;
  border-radius:0.7rem;
  border:1px solid rgba(148,163,184,0.18);
  background: rgba(15,23,42,0.55);
}
#statsPage .rank-bar{
  height:8px;
  border-radius:999px;
  background: rgba(56,189,248,0.12);
  overflow:hidden;
  margin-top:0.25rem;
}
#statsPage .rank-bar > div{
  height:100%;
  background: rgba(56,189,248,0.85);
  box-shadow: 0 0 10px rgba(56,189,248,0.35);
}
#statsPage .rank-name{ color:#e5e7eb; font-size:0.85rem; }
#statsPage .rank-count{ color:#9ca3af; font-size:0.8rem; white-space:nowrap; }

/* Stats: Expandable Rankings */
#statsPage .rank-footer{
  margin-top: 0.55rem;
  display: flex;
  justify-content: center;
}

#statsPage .rank-toggle{
  border: 1px solid rgba(148,163,184,0.28);
  background: rgba(15,23,42,0.6);
  color: #e5e7eb;
  border-radius: 999px;
  padding: 0.35rem 0.8rem;
  cursor: pointer;
  font-size: 0.75rem;
}

#statsPage .rank-toggle:hover{
  background: rgba(56,189,248,0.12);
  border-color: rgba(56,189,248,0.45);
}

#statsPage .rank-more{
  display: none;
  margin-top: 0.45rem;
}

#statsPage .rank-more.show{
  display: block;
}

/* Stats: Ranking Search */
#statsPage .rank-search {
  display: flex;
  gap: 0.4rem;
  align-items: center;
  margin-bottom: 0.6rem;
}

#statsPage .rank-search input {
  width: 100%;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.35);
  background: rgba(15,23,42,0.65);
  color: #e5e7eb;
  padding: 0.35rem 0.65rem;
  font-size: 0.82rem;
}

#statsPage .rank-search input:focus{
  outline: none;
  border-color: rgba(56,189,248,0.55);
  box-shadow: 0 0 0 1px rgba(56,189,248,0.25);
}
#statsPage .airport-flag { font-size: 1rem; margin-right: 0.35rem; }
#statsPage .airport-name { vertical-align: middle; }

.flag-img {
  display: inline-block;
  vertical-align: middle;
  border-radius: 3px;
  margin-right: 8px;
}

.flag-img {
  box-shadow: 0 0 4px rgba(56,189,248,0.25);
}

.flag-img.inline{
  width: 18px;
  height: 12px;
  border-radius: 2px;
  vertical-align: -2px;
  margin-right: 4px;
}
.airport-code{
  font-weight: 600;
}

.leaflet-container { border-radius: 12px; }

.airport-dot{
  filter: drop-shadow(0 0 6px rgba(56,189,248,.6));
}

.marker-cluster-small, .marker-cluster-medium, .marker-cluster-large{
  background: rgba(15,23,42,.55) !important;
  border: 1px solid rgba(56,189,248,.6) !important;
  box-shadow: 0 0 14px rgba(56,189,248,.35);
}
.marker-cluster div{
  background: rgba(2,6,23,.75) !important;
  color: #e5e7eb !important;
  border-radius: 999px !important;
}

.airport-dot {
  filter: drop-shadow(0 0 6px rgba(56,189,248,.6));
}
.flag-img {
  border-radius: 3px;
}

.logo-admin-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: .6rem;
}

.logo-tile {
  position: relative;
  padding: .6rem .5rem .55rem;
  border-radius: 1rem;
  border: 1px solid rgba(148,163,184,0.25);
  background: rgba(15,23,42,0.65);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: .35rem;
}

.logo-tile img {
  width: 100%;
  max-width: 110px;
  height: 44px;
  object-fit: contain;
  background: rgba(2,6,23,0.35);
  border-radius: .45rem;
  padding: .25rem;
}

.logo-tile .airline-name {
  font-weight: 700;
  font-size: .78rem;
  line-height: 1.1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.logo-tile .airline-meta {
  font-size: .7rem;
  color: #9ca3af;
}

.logo-tile .logo-status {
  position: absolute;
  top: .35rem;
  right: .45rem;
  font-size: .9rem;
}

.logo-left{
  display:flex;
  align-items:center;
  gap:.6rem;
  min-width:0;
}

.logo-preview{
  width:56px;
  height:28px;
  object-fit:contain;
  border-radius:.35rem;
  background: rgba(2,6,23,0.35);
  border: 1px solid rgba(148,163,184,0.18);
}

.logo-airline{
  font-weight:700;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.logo-meta{
  font-size:.75rem;
  color:#9ca3af;
  margin-top:.15rem;
}

.logo-status{
  display:flex;
  align-items:center;
  gap:.4rem;
  color:#9ca3af;
  font-size:.78rem;
}

.logo-pill{
  border-radius:999px;
  padding:.15rem .5rem;
  border:1px solid rgba(148,163,184,0.35);
  background: rgba(2,6,23,0.25);
}

.logo-tile {
  position: relative;
  overflow: hidden;
}

.logo-tooltip {
  position: absolute;
  left: 8px;
  right: 8px;
  bottom: 8px;
  padding: 8px 10px;
  border-radius: 12px;
  background: rgba(2, 6, 23, 0.85);
  border: 1px solid rgba(56,189,248,0.35);
  backdrop-filter: blur(10px);
  opacity: 0;
  transform: translateY(6px);
  transition: opacity .15s ease, transform .15s ease;
  pointer-events: none;
  font-size: 0.75rem;
  color: #e5e7eb;
}

.logo-tile:hover .logo-tooltip {
  opacity: 1;
  transform: translateY(0);
}

.logo-tooltip .muted {
  color: #9ca3af;
  font-size: 0.72rem;
}

.logo-tile.show-tooltip .logo-tooltip {
  opacity: 1;
  transform: translateY(0);
}

.dash-tiles{
  display: grid;
  grid-template-columns: 1fr; /* Desktop */
  gap: .65rem;
}

@media (min-width: 900px){
  .dash-tiles{
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: .65rem;
  }
}

.dash-tiles{
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: .5rem;
}

/* Volle Breite (wenn nÃ¶tig) */
.dash-tiles .tile-full{
  grid-column: 1 / -1;
}

/* Quick action chips */
.dash-actions{
  display:flex;
  flex-wrap:wrap;
  gap:.4rem;
  margin-top:.35rem;
}

/* Recent feed */
.dash-recent{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:.5rem;
  margin-top:.35rem;
}
.recent-card{
  border:1px solid rgba(148,163,184,0.22);
  background: rgba(15,23,42,0.55);
  border-radius: .9rem;
  padding:.55rem .6rem;
}
.recent-top{ display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
.recent-route{ font-weight:800; }
.recent-sub{ margin-top:.2rem; color:#9ca3af; font-size:.78rem; }

/* Month bars */
.dash-bars{
  display:flex;
  align-items:flex-end;
  gap:.35rem;
  margin-top:.6rem;
  padding-top:.25rem;
  min-height: 110px;   /* statt fixer height */
}

.dash-bars > div{
  flex: 1;
  min-width: 0;
}

.dash-bar{
  width: 100%;
  min-height: 8px;
  border-radius: 10px 10px 6px 6px;
  background: rgba(56,189,248,0.35);
  border: 1px solid rgba(56,189,248,0.25);
}

.dash-bar:hover{ filter: brightness(1.15); }

.dash-bar-label{
  text-align:center;
  font-size:.68rem;
  color:#9ca3af;
  margin-top:.25rem;
}

/* Mobile etwas kompakter */
@media (max-width: 520px){
  .dash-bars{ min-height: 90px; }
  .dash-bar-label{ font-size: .62rem; }
}

.dash-bar-wrap{
  position: relative;
  display: flex;
  align-items: flex-end;
}

.dash-bar::after{
  content: attr(data-km);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(15,23,42,0.95);
  color: #e5e7eb;
  font-size: .65rem;
  padding: .18rem .4rem;
  border-radius: 6px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity .15s ease, transform .15s ease;
}

.dash-bar::before{
  content:"";
  position:absolute;
  bottom: calc(100% - 2px);
  left:50%;
  transform: translateX(-50%);
  border:5px solid transparent;
  border-top-color: rgba(15,23,42,0.95);
  opacity:0;
  transition: opacity .15s ease;
}

.dash-bar:hover::after,
.dash-bar:hover::before,
.dash-bar.show-tooltip::after,
.dash-bar.show-tooltip::before{
  opacity:1;
  transform: translateX(-50%) translateY(-4px);
}

@media (max-width: 520px){
  .dash-tiles{
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: .5rem;
  }

  /* kompaktere Kacheln */
  .dash-tiles .stat-card{
    padding: .55rem .6rem;
    border-radius: .9rem;
  }

  .dash-tiles .stat-label{
    font-size: .68rem;
    letter-spacing: .06em;
  }

  .dash-tiles .stat-value{
    font-size: 1.05rem;
    line-height: 1.15;
  }

  .dash-tiles .stat-note{
    font-size: .68rem;
    line-height: 1.2;
  }
}

  </style>
</head>
<body>
<header>
  <div>
    <h1><span class="icon">ğŸ›°ï¸</span>FLUGMEILEN</h1>
    <small>Lokale Web-App &ndash; Daten bleiben auf dem Ger&auml;t</small>
  </div>
  <div class="flex-row">
    <select id="yearSelect" class="badge"></select>
    <button id="resetYearBtn" class="btn btn-secondary btn-sm" type="button">
      <span class="icon">ğŸ“…</span>Alle Jahre
    </button>
  </div>
</header>

<main id="dashboardPage">
  <section class="card">
  <h2><span class="icon">ğŸ </span> Dashboard</h2>
  <div id="dashboardTiles" class="dash-tiles"></div>
</section>
</main>

<!-- Seite: FlÃ¼ge -->
<main id="flightsPage" style="display:none;">
  
  <section class="card" id="flightFormCard">
    <h2><span class="icon">ğŸ“</span>Flug erfassen / bearbeiten</h2>
    <div class="form-grid">
      <div>
        <label for="flightDate">Datum</label>
        <input type="date" id="flightDate" />
      </div>
      <div>
        <label for="fromIata">Von (IATA)</label>
        <input type="text" id="fromIata" maxlength="3" placeholder="ZRH" />
      </div>
      <div>
        <label for="toIata">Nach (IATA)</label>
        <input type="text" id="toIata" maxlength="3" placeholder="CUN" />
      </div>
      <div>
        <label for="airline">Airline</label>
        <input type="text" id="airline" placeholder="Swiss" />
      </div>
      <div>
        <label for="aircraft">Flugzeugtyp</label>
        <input type="text" id="aircraft" placeholder="Airbus A320" />
      </div>
      <div>
        <label for="tripType">Privat / Gesch&auml;ft</label>
        <select id="tripType">
          <option value="p">Privat (ğŸ)</option>
          <option value="g">Gesch&auml;ft (ğŸ’¼)</option>
        </select>
      </div>
      <div>
        <label for="speed">Ã˜ Reisegeschwindigkeit [km/h]</label>
        <input type="number" id="speed" value="600" min="300" max="1100" step="10" />
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="flex-row">
          <button id="addFlightBtn" class="btn btn-primary" type="button">
            <span class="icon">â•</span>Flug speichern
          </button>
          <button id="cancelEditBtn" class="btn btn-secondary btn-sm" type="button" style="display:none;">
            <span class="icon">â†©</span>Abbrechen
          </button>
        </div>
      </div>
    </div>
    <div id="flightError" class="error"></div>
  </section>

  <section class="card">
    <div class="toolbar flights-toolbar">
      <div class="flex-row">
        <h2 style="margin:0;"><span class="icon">ğŸ“‘</span>Flugliste</h2>
        <span id="visibleCount" class="badge">
          <span class="icon">ğŸ‘€</span>0 sichtbar
        </span>
      </div>
      <div class="flex-row">
        <input type="search" id="searchInput" placeholder="Suche (IATA, Stadt, Airline)" />
        <button id="clearAllFlightsBtn" class="btn btn-secondary btn-sm" type="button">
          <span class="icon">ğŸ—‘</span>Alle l&ouml;schen
        </button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>#</th>
          <th>Datum</th>
          <th>Von</th>
          <th>Nach</th>
          <th>Airline</th>
          <th>Aircraft</th>
          <th>Distanz</th>
          <th>Dauer</th>
          <th>Typ</th>
          <th></th>
        </tr>
        </thead>
        <tbody id="flightTableBody"></tbody>
      </table>
    </div>
	<div id="flightsEmptyState" class="empty-state" style="display:none;"></div>
  </section>
</main>

<!-- Seite: Statistik -->
<main id="statsPage" style="display:none;">
  <section class="card">
    <h2><span class="icon">ğŸ“Š</span>Gesamtstatistik (alle Fl&uuml;ge)</h2>
    <div id="statsAllYears" class="stats-grid"></div>
  </section>

  <section class="card">
    <h2><span class="icon">ğŸ“…</span>Statistik f&uuml;r gew&auml;hltes Jahr</h2>
    <div id="statsSelectedYear" class="stats-grid"></div>
  </section>

  <section class="card">
    <h2><span class="icon">ğŸŒ</span>Weltkarte aller Fl&uuml;ge (gew&auml;hltes Jahr / Filter)</h2>
    <div id="map" style="height:350px; border-radius:12px;"></div>
  </section>

  <section class="card">
    <h2><span class="icon">âœˆï¸</span>Flugh&auml;fen (Besuche)</h2>
    <div id="statsAirports"></div>
  </section>
  
  <section class="card">
    <h2>ğŸŒ LÃ¤nder</h2>
    <div id="statsCountries"></div>
  </section>

  <section class="card">
    <h2><span class="icon">ğŸ›«</span>Airlines</h2>
    <div id="statsAirlines"></div>
  </section>

  <section class="card">
    <h2><span class="icon">ğŸ›©</span>Flugzeugtypen</h2>
    <div id="statsAircrafts"></div>
  </section>

  <section class="card">
    <h2><span class="icon">ğŸ†</span>Top 5</h2>
    <div class="form-grid">
      <div>
        <h3>Flugh&auml;fen</h3>
        <div id="topAirports"></div>
      </div>
      <div>
        <h3>Airlines</h3>
        <div id="topAirlines"></div>
      </div>
      <div>
        <h3>Flugzeugtypen</h3>
        <div id="topAircrafts"></div>
      </div>
    </div>
  </section>
</main>

<!-- Seite: Daten & Import -->
<main id="dataPage" style="display:none;">
  <section class="card">
    <div class="toolbar">
      <div>
        <h2><span class="icon">ğŸ›¬</span>Flughafen-Daten</h2>
        <div class="muted">CSV mit IATA, Stadt, Breite, L&auml;nge aus deinem Excelblatt <b>FlughafenDaten</b> importieren.</div>
      </div>
      <span id="airportCount" class="badge"><span class="icon">ğŸ›°ï¸</span>0 Airports</span>
    </div>
    <div class="form-grid" style="margin-top:0.5rem;">
      <div>
        <label for="airportFile">airports.csv w&auml;hlen</label>
        <input type="file" id="airportFile" accept=".csv,text/csv" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="loadAirportBtn" class="btn btn-secondary btn-sm" type="button">
          <span class="icon">ğŸ“¥</span>CSV laden
        </button>
      </div>
      <div style="grid-column:1/-1">
        <div class="muted">
          Erwartete Spaltennamen: <span class="pill pill-soft">IATA</span>,
          <span class="pill pill-soft">Stadt</span>,
          <span class="pill pill-soft">Breite</span>,
          <span class="pill pill-soft">L&auml;nge</span> (Trennzeichen ; oder ,).
        </div>
      </div>
    </div>
    <div id="airportError" class="error"></div>
  </section>

  <section class="card">
    <div class="toolbar">
      <div>
        <h2><span class="icon">ğŸ“„</span>Fl&uuml;ge aus Excel-CSV importieren</h2>
        <div class="muted">
          Pro Jahr ein CSV (z.B. <code>flights_2014.csv</code>) mit Spalten
          <span class="pill pill-soft">Datum</span>,
          <span class="pill pill-soft">Von-IATA</span>,
          <span class="pill pill-soft">Nach-IATA</span>,
          <span class="pill pill-soft">Airline</span>,
          <span class="pill pill-soft">Aircraft</span>,
          <span class="pill pill-soft">Typ (p/g)</span>.
          IATA steht dabei wie in Excel als <code>Z&uuml;rich (ZRH)</code>.
        </div>
      </div>
      <span id="flightImportInfo" class="badge"></span>
    </div>
    <div class="form-grid" style="margin-top:0.5rem;">
      <div>
        <label for="flightsFile">flights_YYYY.csv w&auml;hlen</label>
        <input type="file" id="flightsFile" accept=".csv,text/csv" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="loadFlightsBtn" class="btn btn-secondary btn-sm" type="button">
          <span class="icon">ğŸ“¥</span>Fl&uuml;ge laden
        </button>
      </div>
    </div>
    <div id="flightsImportError" class="error"></div>
  </section>
</main>

<main id="profilePage" style="display:none;">

  <section class="card">
    <h2><span class="icon">ğŸ‘¤</span> Profil</h2>
    <div class="muted">
      Einstellungen & Verwaltung (Logos, Backup, Daten-Check).
    </div>

    <div class="form-grid" style="margin-top:.6rem;">
      <div>
        <label for="profileName">Name</label>
        <input id="profileName" type="text" placeholder="Daniel" />
      </div>

      <div>
        <label for="homeIata">Home-Airport (IATA)</label>
        <input id="homeIata" type="text" maxlength="3" placeholder="ZRH" />
      </div>

      <div>
        <label for="defaultSpeed">Standard-Speed (km/h)</label>
        <input id="defaultSpeed" type="number" min="300" max="1100" step="10" placeholder="600" />
      </div>

      <div>
        <label>&nbsp;</label>
        <button id="saveProfileBtn" class="btn btn-primary" type="button">
          <span class="icon">ğŸ’¾</span> Speichern
        </button>
      </div>
    </div>

    <div id="profileSavedNote" class="muted" style="margin-top:.4rem;"></div>
  </section>

  <section class="card">
    <div class="toolbar">
      <div>
        <h2 style="margin:0;"><span class="icon">ğŸ–¼</span> Airline-Logos</h2>
        <div class="muted">Aus deinen gespeicherten FlÃ¼gen automatisch erkannt.</div>
      </div>

      <div class="flex-row">
        <span id="profileLogoStats" class="badge">â€“</span>
        <button id="toggleMissingBtn" class="btn btn-secondary btn-sm" type="button">
          <span class="icon">ğŸ•µï¸</span> Nur fehlende
        </button>
      </div>
    </div>

    <div class="rank-search" style="margin-top:.5rem;">
      <input type="search" id="profileLogoSearch" placeholder="Airline suchenâ€¦" />
    </div>

    <div id="profileAirlineList" class="logo-admin-list" style="margin-top:.5rem;"></div>
  </section>

  <section class="card">
    <h2><span class="icon">ğŸ’¾</span> Backup</h2>
    <div class="muted">Exportiert/Importiert deine FlÃ¼ge & Airports (localStorage).</div>

    <div class="flex-row" style="margin-top:.6rem;">
      <button id="exportBtn" class="btn btn-secondary btn-sm" type="button">
        <span class="icon">â¬‡ï¸</span> Export JSON
      </button>

      <label class="btn btn-secondary btn-sm" style="cursor:pointer;">
        <span class="icon">â¬†ï¸</span> Import JSON
        <input id="importFile" type="file" accept="application/json" style="display:none;">
      </label>

      <button id="resetDataBtn" class="btn btn-secondary btn-sm" type="button">
        <span class="icon">ğŸ§¨</span> Reset (alles)
      </button>
    </div>

    <div id="backupMsg" class="muted" style="margin-top:.4rem;"></div>
  </section>

</main>

<script>
  const STORAGE_KEY_FLIGHTS = "flugmeilen_flights_v3";
  const STORAGE_KEY_AIRPORTS = "flugmeilen_airports_v3";
  
  // Airline -> Logo-Datei (SchlÃ¼ssel in GROSSSCHRIFT)
const AIRLINE_LOGOS = {
  "SWISS": "img/airlines/Swiss.png",
  "LUFTHANSA": "img/airlines/Lufthansa.png",
  "EUROWINGS": "img/airlines/Eurowings.png",
  "EDELWEISS": "img/airlines/Edelweiss.png",
  "RYANAIR": "img/airlines/Ryanair.png",
  "EASYJET": "img/airlines/Easyjet.png",
  "AIR FRANCE": "img/airlines/Air France.png",
  "AIR BALTIC": "img/airlines/Air Baltic.png",
  "AUSTRIAN": "img/airlines/Austrian.png",
  "HELVETIC": "img/airlines/Helvetic.png",
  "TURKISH AIRLINES": "img/airlines/Turkish Airlines.png",
  "EMIRATES": "img/airlines/Emirates.png",
  "AIR DOLOMITI": "img/airlines/Air Dolomiti.png",
  "BRUSSELS AIRLINES": "img/airlines/Brussels Airlines.png",
  "AEGAEN": "img/airlines/Aegaen.png",
  "AIR ALGERIE": "img/airlines/Air Algerie.png",
  "AIR BERLIN": "img/airlines/Air Berlin.png",
  "AIR CHINA": "img/airlines/Air China.png",
  "AIR INDIA": "img/airlines/Air India.png",
  "AIR MALTA": "img/airlines/Air Malta.png",
  "BANGKOK AIRWAYS": "img/airlines/Bangkok Airways.png",
  "BRITISH AIRWAYS": "img/airlines/British Airways.png",
  "CHINA EASTERN": "img/airlines/China Eastern.png",
  "DELTA AIRLINES": "img/airlines/Delta Airlines.png",
  "EGYPTAIR": "img/airlines/Egyptair.png",
  "ETHIOPIAN": "img/airlines/Ethiopian.png",
  "ETIHAD": "img/airlines/Etihad.png",
  "EUROWINGS": "img/airlines/Eurowings.png",
  "FINNAIR": "img/airlines/Finnair.png",
  "GERMANIA": "img/airlines/Germania.png",
  "HAWAIIAN": "img/airlines/Hawaiian.png",
  "IBERIA": "img/airlines/Iberia.png",
  "KLM": "img/airlines/KLM.png",
  "LATAM": "img/airlines/Latam.png",
  "MALAWIAN AIRWAYS": "img/airlines/Malawian Airways.png",
  "NIKI": "img/airlines/Niki.png",
  "QANTAS": "img/airlines/Qantas.png",
  "QATAR": "img/airlines/Qatar Airways.png",
  "SAUDIA": "img/airlines/Saudia.png",
  "SOUTH AFRICAN": "img/airlines/South African.png",
  "SUNEXPRESS": "img/airlines/SunExpress.png",
  "TAP": "img/airlines/Tap.png",
  "THAI SMILE": "img/airlines/Thai Smile.png",
  "TIGERAIR": "img/airlines/Tigerair.png",
  "UNITED": "img/airlines/United.png",
  "VIRGIN AU": "img/airlines/Virgin AU.png",
  "VUELING": "img/airlines/Vueling.png",
  "XIAMEN AIR": "img/airlines/Xiamen Air.png",
  "CHINA SOUTHERN": "img/airlines/China Southern.png",
  "GERMANWINGS": "img/airlines/Germanwings.png",
  
  // hier kannst du beliebig erweitern
};

function getHomeAirportIata(){
  try {
    const raw = localStorage.getItem("flugmeilen_profile_v1");
    if (!raw) return "";
    const p = JSON.parse(raw);

    // dein Feld heiÃŸt sehr wahrscheinlich genau so:
    const v = p["homeIata"] || p.homeAirport || p.homeAirportIata || "";
    const s = String(v).trim();

    // IATA extrahieren (falls jemand "ZÃ¼rich (ZRH)" gespeichert hat)
    const m = s.match(/([A-Za-z]{3})/);
    return m ? m[1].toUpperCase() : "";
  } catch (e) {
    return "";
  }
}

function logAllAirlinesFromData() {
  const flights = loadFlights();
  const set = new Set(
    flights
      .map(f => (f.airline || "").trim())
      .filter(Boolean)
      .map(a => a.toUpperCase())
  );
  console.log("Distinct airlines in deinen Flugdaten:", Array.from(set));
}

  let AIRPORTS = loadAirportsFromStorage();
  let leafletMap = null;
  let editingFlightId = null;

  function loadAirportsFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_AIRPORTS);
      if (!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj === "object" ? obj : {};
    } catch (e) {
      return {};
    }
  }
  function saveAirportsToStorage() {
    localStorage.setItem(STORAGE_KEY_AIRPORTS, JSON.stringify(AIRPORTS));
  }

  function loadFlights() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_FLIGHTS);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch (e) {
      return [];
    }
  }
  function saveFlights(flights) {
    localStorage.setItem(STORAGE_KEY_FLIGHTS, JSON.stringify(flights));
  }

  function deg2rad(deg) { return deg * Math.PI / 180; }

  function calcDistanceKm(fromCode, toCode) {
    const a1 = AIRPORTS[fromCode];
    const a2 = AIRPORTS[toCode];
    if (!a1 || !a2) return null;
    const R = 6371;
    const lat1 = deg2rad(a1.lat), lon1 = deg2rad(a1.lon);
    const lat2 = deg2rad(a2.lat), lon2 = deg2rad(a2.lon);
    const dlat = lat2 - lat1;
    const dlon = lon2 - lon1;
    const h = Math.sin(dlat/2)*Math.sin(dlat/2) +
              Math.cos(lat1)*Math.cos(lat2)*Math.sin(dlon/2)*Math.sin(dlon/2);
    const c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1-h));
    return R * c;
  }

  function calcDurationHours(distanceKm, speedKmh) {
    if (!distanceKm || !speedKmh) return null;
    return distanceKm / speedKmh + 0.5;
  }

  function formatKm(km) {
    if (!km) return "â€“";
    return km.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,"'") + " km";
  }

  function formatMiles(km) {
    if (!km) return "â€“";
    const miles = km * 0.621371;
    return miles.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,"'") + " mi";
  }

  function formatHours(hours) {
    if (!hours) return "â€“";
    const totalMin = Math.round(hours * 60);
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    return String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0") + " h";
  }

  function hoursToText(hours) {
    if (!hours) return "";
    const totalMin = Math.round(hours * 60);
    const d = Math.floor(totalMin / (24*60));
    const remMin = totalMin - d*24*60;
    const h = Math.floor(remMin/60);
    const m = remMin % 60;
    const parts = [];
    if (d) parts.push(d + " Tage");
    if (h) parts.push(h + " Stunden");
    if (m) parts.push(m + " Minuten");
    return parts.join(" ");
  }

  function formatDate(dateStr) {
    if (!dateStr) return "â€“";
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr;
    return d.toLocaleDateString();
  }

function parseCsvAirports(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
  if (!lines.length) throw new Error("CSV ist leer.");

  const delimiter = lines[0].includes(";") ? ";" : ",";
  const headerRaw = lines[0].split(delimiter).map(h => h.trim());

  // Header normalisieren: BOM weg, spaces weg, umlaut->ae/oe/ue
  const headerNorm = headerRaw.map(h =>
    h
      .toLowerCase()
      .replace(/^\ufeff/, "")
      .replace(/\s+/g, "")
      .replace(/Ã¤/g, "ae")
      .replace(/Ã¶/g, "oe")
      .replace(/Ã¼/g, "ue")
      .replace(/ÃŸ/g, "ss")
  );

  function findCol(...names) {
    return headerNorm.findIndex(h => names.includes(h));
  }

  const idxIata = findCol("iata");
  const idxCity = findCol("stadt", "city");
  const idxLat  = findCol("breite", "lat", "latitude");
  // âœ… hier auch "laenge" UND "laenge"/"lange" UND "laenge" abdecken
  const idxLon  = findCol("laenge", "lange", "laenge", "lon", "long", "longitude");
  const idxIso2 = findCol("iso2", "country", "land");

  if (idxIata === -1 || idxCity === -1 || idxLat === -1 || idxLon === -1) {
    throw new Error("Spalten nicht gefunden. Gefunden wurden: " + headerRaw.join(" | "));
  }

  const result = {};

  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(delimiter);
    if (!parts.length) continue;

    const code = (parts[idxIata] || "").trim().toUpperCase();
    if (!code || code.length !== 3) continue;

    const city = (parts[idxCity] || "").trim();

    const lat = parseFloat((parts[idxLat] || "").replace(",", "."));
    const lon = parseFloat((parts[idxLon] || "").replace(",", "."));
    if (!isFinite(lat) || !isFinite(lon)) continue;

    const iso2 = idxIso2 >= 0 ? (parts[idxIso2] || "").trim().toUpperCase() : "";

    result[code] = { city, lat, lon, country: iso2 };
  }

  return result;
}

function renderFlagImg(iso2, size = 18) {
  if (!iso2 || iso2.length !== 2) return "";
  const code = iso2.toLowerCase();
  return `
    <img
      src="https://flagcdn.com/w20/${code}.png"
      srcset="https://flagcdn.com/w40/${code}.png 2x"
      width="${size}"
      height="${Math.round(size * 0.75)}"
      class="flag-img"
      alt="${iso2}"
      loading="lazy"
    >
  `;
}

function countryToFlagEmoji(countryCode) {
  if (!countryCode || countryCode.length !== 2) return "";
  const codePoints = countryCode
    .toUpperCase()
    .split("")
    .map(c => 127397 + c.charCodeAt(0));
  return String.fromCodePoint(...codePoints);
}

function renderAirportWithFlag(iata) {
  const a = AIRPORTS[iata];
  if (!a) return iata;

  const flag = renderFlagImg(a.country);
  return `
    ${flag}
    <span class="airport-name">${a.city} (${iata})</span>
  `;
}
function flagImgHtml(iso2){
  const cc = (iso2 || "").toLowerCase();
  if (!cc || cc.length !== 2) return "";
  return `<img class="flag-img inline" src="https://flagcdn.com/w20/${cc}.png" alt="">`;
}

function airportCodeWithFlag(iata){
  const a = AIRPORTS[iata];
  if (!a) return iata;
  const iso2 = (a.country || "").toLowerCase();
  const flag = iso2 ? `<img class="flag-img inline" src="https://flagcdn.com/w20/${iso2}.png" alt="">` : "";
  return `${flag}<span class="airport-code">${iata}</span>`;
}

function airportCityLabel(iata){
  const a = AIRPORTS[iata];
  return a ? (a.city || iata) : iata;
}

function computeCountryCounts(flights) {
  const airportVisits = {};

  flights.forEach(f => {
    [f.from, f.to].forEach(code => {
      const a = AIRPORTS[code];
      if (!a || !a.country) return;

      const country = a.country.toUpperCase();
      airportVisits[country] = (airportVisits[country] || 0) + 1;
    });
  });

  // Hin- & RÃ¼ckflug = 1 Besuch
  const countryVisits = {};
  for (const [country, count] of Object.entries(airportVisits)) {
    countryVisits[country] = Math.ceil(count / 2);
  }

  return sortedEntries(countryVisits);
}

  function handleAirportCsvLoad() {
    const fileInput = document.getElementById("airportFile");
    const errBox = document.getElementById("airportError");
    errBox.textContent = "";
    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      errBox.textContent = "Bitte eine CSV-Datei ausw\u00e4hlen.";
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const parsed = parseCsvAirports(text);
        AIRPORTS = parsed;
        saveAirportsToStorage();
        updateAirportCount();
        renderAll();
      } catch (err) {
        errBox.textContent = "Fehler beim Einlesen: " + err.message;
      }
    };
    reader.onerror = () => { errBox.textContent = "Fehler beim Lesen der Datei."; };
    reader.readAsText(file, "utf-8");
  }

  function updateAirportCount() {
    const el = document.getElementById("airportCount");
    const n = Object.keys(AIRPORTS).length;
    el.innerHTML = "<span class=\"icon\">ğŸ›°ï¸</span>"+n + (n === 1 ? " Airport" : " Airports");
  }

  function setEditMode(active) {
    const card = document.getElementById("flightFormCard");
    const btn = document.getElementById("addFlightBtn");
    const cancel = document.getElementById("cancelEditBtn");
    if (active) {
      card.classList.add("edit-active");
      btn.classList.add("btn-warning");
      btn.classList.remove("btn-primary");
      cancel.style.display = "inline-flex";
      btn.innerHTML = '<span class="icon">ğŸ’¾</span>&Auml;nderungen speichern';
    } else {
      card.classList.remove("edit-active");
      btn.classList.remove("btn-warning");
      btn.classList.add("btn-primary");
      cancel.style.display = "none";
      btn.innerHTML = '<span class="icon">â•</span>Flug speichern';
    }
  }

  function addFlight() {
    const date = document.getElementById("flightDate").value;
    const fromIata = document.getElementById("fromIata").value.trim().toUpperCase();
    const toIata = document.getElementById("toIata").value.trim().toUpperCase();
    const airline = document.getElementById("airline").value.trim();
    const aircraft = document.getElementById("aircraft").value.trim();
    const tripType = document.getElementById("tripType").value;
    const speed = Number(document.getElementById("speed").value);
    const errBox = document.getElementById("flightError");
    errBox.textContent = "";

    const errors = [];
    if (!date) errors.push("Datum fehlt.");
    if (!fromIata || fromIata.length !== 3) errors.push("Von-IATA muss 3 Zeichen haben.");
    if (!toIata || toIata.length !== 3) errors.push("Nach-IATA muss 3 Zeichen haben.");
    if (!speed || speed <= 0) errors.push("Geschwindigkeit muss > 0 sein.");
    if (!AIRPORTS[fromIata]) errors.push("Unbekannter Abflugairport: " + fromIata);
    if (!AIRPORTS[toIata]) errors.push("Unbekannter Zielairport: " + toIata);

    if (errors.length) {
      errBox.textContent = errors.join(" ");
      return;
    }

    const distanceKm = calcDistanceKm(fromIata, toIata);
    const durationHours = calcDurationHours(distanceKm, speed);

    const flights = loadFlights();

    if (editingFlightId === null) {
      const newFlight = {
        id: Date.now(),
        date,
        from: fromIata,
        to: toIata,
        airline,
        aircraft,
        tripType,
        speedKmh: speed,
        distanceKm,
        durationHours
      };
      flights.push(newFlight);
      document.getElementById("airline").value = "";
      document.getElementById("aircraft").value = "";
    } else {
      const idx = flights.findIndex(f => String(f.id) === String(editingFlightId));
      if (idx !== -1) {
        flights[idx] = {
          ...flights[idx],
          date,
          from: fromIata,
          to: toIata,
          airline,
          aircraft,
          tripType,
          speedKmh: speed,
          distanceKm,
          durationHours
        };
      }
    }

    saveFlights(flights);
    editingFlightId = null;
    setEditMode(false);
    renderAll();
  }

  function startEditFlight(id) {
    const flights = loadFlights();
    const f = flights.find(fl => String(fl.id) === String(id));
    if (!f) return;

    editingFlightId = f.id;

    document.getElementById("flightDate").value = f.date || "";
    document.getElementById("fromIata").value = f.from || "";
    document.getElementById("toIata").value = f.to || "";
    document.getElementById("airline").value = f.airline || "";
    document.getElementById("aircraft").value = f.aircraft || "";
    document.getElementById("tripType").value = f.tripType || "p";
    document.getElementById("speed").value = f.speedKmh || 600;
    document.getElementById("flightError").textContent = "";

    setEditMode(true);
  }

  function cancelEdit() {
    editingFlightId = null;
    document.getElementById("flightDate").value = "";
    document.getElementById("fromIata").value = "";
    document.getElementById("toIata").value = "";
    document.getElementById("airline").value = "";
    document.getElementById("aircraft").value = "";
    document.getElementById("tripType").value = "p";
    document.getElementById("speed").value = 600;
    document.getElementById("flightError").textContent = "";
    setEditMode(false);
  }

  function deleteFlight(id) {
    const flights = loadFlights();
    const next = flights.filter(f => String(f.id) !== String(id));
    saveFlights(next);
    if (String(editingFlightId) === String(id)) {
      editingFlightId = null;
      setEditMode(false);
    }
    renderAll();
  }

  function clearAllFlights() {
    if (!confirm("Alle gespeicherten Fl\u00fcge wirklich l\u00f6schen?")) return;
    localStorage.removeItem(STORAGE_KEY_FLIGHTS);
    editingFlightId = null;
    setEditMode(false);
    renderAll();
  }

  function parseCsvFlights(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (!lines.length) throw new Error("CSV ist leer.");

    const delimiter = lines[0].includes(";") ? ";" : ",";
    const header = lines[0].split(delimiter).map(h => h.trim().toLowerCase());

    const idxDatum   = header.findIndex(h => h === "datum");
    const idxVon     = header.findIndex(h => h === "von-iata");
    const idxNach    = header.findIndex(h => h === "nach-iata");
    const idxAirline = header.findIndex(h => h === "airline");
    const idxAircr   = header.findIndex(h => h === "aircraft");
    const idxTyp     = header.findIndex(h => h === "typ");

    if (idxDatum === -1 || idxVon === -1 || idxNach === -1) {
      throw new Error("Spalten 'Datum', 'Von-IATA' und 'Nach-IATA' m\u00fcssen vorhanden sein.");
    }

    const flights = [];

    function extractIata(s) {
      const m = /\(([A-Za-z]{3})\)$/.exec(s.trim());
      return m ? m[1].toUpperCase() : null;
    }

    for (let i = 1; i < lines.length; i++) {
      const parts = lines[i].split(delimiter);
      if (!parts.length) continue;

      let rawDate = (parts[idxDatum] || "").trim();

      if (/^\d{2}\.\d{2}\.\d{4}$/.test(rawDate)) {
        const [dd, mm, yyyy] = rawDate.split(".");
        rawDate = `${yyyy}-${mm}-${dd}`;
      } else if (!/^\d{4}-\d{2}-\d{2}$/.test(rawDate)) {
        const d = new Date(rawDate);
        if (!isNaN(d)) {
          const y = d.getFullYear();
          const m = String(d.getMonth()+1).padStart(2,"0");
          const day = String(d.getDate()).padStart(2,"0");
          rawDate = `${y}-${m}-${day}`;
        }
      }

      const fromStr = parts[idxVon]  || "";
      const toStr   = parts[idxNach] || "";
      const from = extractIata(fromStr);
      const to   = extractIata(toStr);
      if (!from || !to) continue;

      const airline  = idxAirline >= 0 ? (parts[idxAirline] || "").trim() : "";
      const aircraft = idxAircr   >= 0 ? (parts[idxAircr]   || "").trim() : "";
      let tripType   = idxTyp     >= 0 ? (parts[idxTyp]     || "").trim().toLowerCase() : "p";
      if (tripType.startsWith("g")) tripType = "g"; else tripType = "p";

      const distanceKm = calcDistanceKm(from, to);
      const durationHours = distanceKm ? calcDurationHours(distanceKm, 850) : null;

      flights.push({
        id: Date.now() + i,
        date: rawDate,
        from,
        to,
        airline,
        aircraft,
        tripType,
        speedKmh: 850,
        distanceKm,
        durationHours
      });
    }

    return flights;
  }

  function handleFlightsCsvLoad() {
    const fileInput = document.getElementById("flightsFile");
    const errBox    = document.getElementById("flightsImportError");
    const infoBox   = document.getElementById("flightImportInfo");
    errBox.textContent = "";
    infoBox.textContent = "";

    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      errBox.textContent = "Bitte eine Flights-CSV ausw\u00e4hlen.";
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const imported = parseCsvFlights(text);

        if (!imported.length) {
          errBox.textContent = "Keine g\u00fcltigen Fl\u00fcge in der CSV gefunden.";
          return;
        }

        const existing = loadFlights();
        const all = existing.concat(imported);
        saveFlights(all);
        infoBox.textContent = imported.length + " Fl\u00fcge importiert.";
        renderAll();
      } catch (err) {
        errBox.textContent = "Fehler beim Einlesen: " + err.message;
      }
    };
    reader.onerror = () => {
      errBox.textContent = "Fehler beim Lesen der Datei.";
    };
    reader.readAsText(file, "windows-1252");
  }

  function getSelectedYear() {
    const val = document.getElementById("yearSelect").value;
    return val === "" ? null : Number(val);
  }

  function buildYearOptions(flights) {
    const years = new Set();
    for (const f of flights) {
      if (!f.date) continue;
      const y = new Date(f.date).getFullYear();
      if (!isNaN(y)) years.add(y);
    }
    const arr = Array.from(years).sort((a,b)=>a-b);
    const sel = document.getElementById("yearSelect");
    const current = sel.value;
    sel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "Alle Jahre";
    sel.appendChild(optAll);
    for (const y of arr) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = y;
      sel.appendChild(opt);
    }
    if (current) sel.value = current;
  }

  function applyFilters(flights) {
    const year = getSelectedYear();
    const search = document.getElementById("searchInput").value.trim().toLowerCase();
    let filtered = flights;
    if (year) {
      filtered = filtered.filter(f => {
        const d = new Date(f.date);
        return !isNaN(d) && d.getFullYear() === year;
      });
    }
    if (search) {
      filtered = filtered.filter(f => {
        const aFrom = AIRPORTS[f.from] || {};
        const aTo = AIRPORTS[f.to] || {};
        const hay = [
          f.from, f.to,
          aFrom.city, aTo.city,
          f.airline, f.aircraft
        ].filter(Boolean).join(" ").toLowerCase();
        return hay.includes(search);
      });
    }
    return filtered;
  }

  function countOccurrences(array, keyFn) {
    const map = {};
    array.forEach(item => {
      const key = keyFn(item);
      if (!key) return;
      map[key] = (map[key] || 0) + 1;
    });
    return map;
  }

  function sortedEntries(obj) {
    return Object.entries(obj).sort((a,b)=>b[1]-a[1]);
  }

  function buildStatsTable(entries) {
    if (!entries.length) return "<span class=\"muted\">Keine Daten</span>";
    let html = "<table><tbody>";
    entries.forEach(([name,count])=>{
      html += "<tr><td>"+name+"</td><td style=\"text-align:right;\">"+count+"</td></tr>";
    });
    html += "</tbody></table>";
    return html;
  }

function buildRankBarsExpandable(entries, topN = 10, options = {}) {
  const {
    withSearch = true,
    searchPlaceholder = "Suchen...",
    renderNameHtml = (name) => name
  } = options;

  if (!entries || !entries.length) return "<span class='muted'>Keine Daten</span>";

  const uid = "rk_" + Math.random().toString(36).slice(2);
  const max = entries[0][1] || 1;

  const renderRows = (arr) => `
    <div class="rank-bars">
      ${arr.map(([name,count]) => `
        <div class="rank-row" data-name="${String(name).toLowerCase()}">
          <div>
            <div class="rank-name">${renderNameHtml(name)}</div>
            <div class="rank-bar"><div style="width:${Math.round(count/max*100)}%"></div></div>
          </div>
          <div class="rank-count">${count}</div>
        </div>
      `).join("")}
    </div>
  `;

  const top = entries.slice(0, topN);
  const rest = entries.slice(topN);

  return `
    ${withSearch ? `
      <div class="rank-search">
        <input type="search" id="${uid}_search" placeholder="${searchPlaceholder}">
      </div>
    ` : ""}

    <div id="${uid}_wrap">
      ${renderRows(top)}
      ${rest.length ? `
        <div id="${uid}_more" class="rank-more">${renderRows(rest)}</div>
        <div class="rank-footer">
          <button class="rank-toggle" type="button" data-toggle="${uid}" data-total="${entries.length}">
            Alle anzeigen (${entries.length})
          </button>
        </div>
      ` : `<div class="rank-footer"><span class="muted">Alle angezeigt (${entries.length})</span></div>`}
    </div>
  `;
}

  // Karte mit Clustering
  function renderMap(flights) {
  const mapDiv = document.getElementById("map");
  if (!mapDiv) return;

  // Wenn die Karte schon existiert, entfernen wir sie
  if (leafletMap) {
    leafletMap.remove();
    leafletMap = null;
  }

  // Erstelle eine neue Karte
  leafletMap = L.map("map").setView([20, 0], 2);

  // --- Basemaps ---
  const streetLayer = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
    {
      maxZoom: 10,
      attribution: "&copy; OpenStreetMap &copy; CARTO"
    }
  );

  const satelliteLayer = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    {
      maxZoom: 19,
      attribution:
        "Tiles &copy; Esri â€” Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community"
    }
  );

  // StandardmÃ¤ÃŸig Street Layer anzeigen
  streetLayer.addTo(leafletMap);

  // --- Overlay: Airports (Cluster) ---
  const airportCodes = new Set();
  flights.forEach(f => {
    if (AIRPORTS[f.from]) airportCodes.add(f.from);
    if (AIRPORTS[f.to]) airportCodes.add(f.to);
  });

  const bounds = [];
  const markerCluster =
    typeof L.markerClusterGroup === "function"
      ? L.markerClusterGroup()
      : L.layerGroup();

  airportCodes.forEach(code => {
    const a = AIRPORTS[code];
    if (!a) return;

    const latlng = [a.lat, a.lon];

    const marker = L.circleMarker(latlng, {
  radius: 6,
  className: "airport-dot",
  weight: 1,
  opacity: 0.9,
  fillOpacity: 0.95
}).bindPopup(
  (a.city || code) + " (" + code + ")"
);

markerCluster.addLayer(marker);


    markerCluster.addLayer(marker);
    bounds.push(latlng);
  });

  markerCluster.addTo(leafletMap);

  // --- Layer Control (Basemap Toggle + Overlay Toggle) ---
  const baseMaps = {
    "Street View": streetLayer,
    "Satellite": satelliteLayer
  };

  const overlays = {
    "Airports": markerCluster
  };

  L.control.layers(baseMaps, overlays, { collapsed: true }).addTo(leafletMap);

  // ğŸ”§ Wichtig: wenn Layer gewechselt wird â†’ GrÃ¶ÃŸe neu berechnen
  leafletMap.on("baselayerchange", () => {
    setTimeout(() => leafletMap.invalidateSize(), 80);
  });

  // Setze die Kartenansicht auf die FlughÃ¤fen
  if (bounds.length) {
    leafletMap.fitBounds(bounds, { padding: [20, 20] });
  }

  // ğŸ”§ Wichtig bei Tabs/hidden container
  setTimeout(() => leafletMap.invalidateSize(), 150);
}

function airportPopupHtml(iata, visitCounts){
  const a = AIRPORTS[iata];
  if (!a) return iata;

  const iso2 = (a.country || "").toLowerCase();
  const flag = iso2
    ? `<img class="flag-img" src="https://flagcdn.com/w20/${iso2}.png">`
    : "";

  const visits = visitCounts?.[iata] ?? 0;

  return `
    <div style="display:flex;gap:8px;align-items:center;">
      ${flag}
      <div>
        <div style="font-weight:700;">
          ${a.city || iata} (${iata})
        </div>
        <div class="muted">Besuche: <b>${visits}</b></div>
      </div>
    </div>
  `;
}

function renderDashboardDetails(flights) {
  const totalKmEl        = document.getElementById("dashTotalKm");
  const longestRouteEl   = document.getElementById("dashLongestRoute");
  const longestDescEl    = document.getElementById("dashLongestDesc");
  const shortestRouteEl  = document.getElementById("dashShortestRoute");
  const shortestDescEl   = document.getElementById("dashShortestDesc");
  const mostRouteEl      = document.getElementById("dashMostRoute");
  const mostRouteCountEl = document.getElementById("dashMostRouteCount");

  if (!totalKmEl && !longestRouteEl && !shortestRouteEl && !mostRouteEl) {
    // Falls die unteren Cards (noch) nicht existieren, einfach nichts tun
    return;
  }

  if (!flights.length) {
    if (totalKmEl)        totalKmEl.textContent        = "0 km";
    if (longestRouteEl)   longestRouteEl.textContent   = "â€“";
    if (longestDescEl)    longestDescEl.textContent    = "";
    if (shortestRouteEl)  shortestRouteEl.textContent  = "â€“";
    if (shortestDescEl)   shortestDescEl.textContent   = "";
    if (mostRouteEl)      mostRouteEl.textContent      = "â€“";
    if (mostRouteCountEl) mostRouteCountEl.textContent = "";
    return;
  }

  // --- Ãœbersicht: Gesamtkilometer ---
  const totalKm = flights.reduce((s,f)=>s+(f.distanceKm||0),0);
  if (totalKmEl) totalKmEl.textContent = totalKm.toLocaleString()+" km";

  // --- LÃ¤ngster / KÃ¼rzester Flug ---
  const flightsWithDist = flights.filter(f => f.distanceKm);
  let longest = null;
  let shortest = null;
  flightsWithDist.forEach(f => {
    if (!longest  || f.distanceKm > longest.distanceKm) longest  = f;
    if (!shortest || f.distanceKm < shortest.distanceKm) shortest = f;
  });

  function routeLabel(f) {
    if (!f) return "â€“";
    return (f.from || "?") + " \u2192 " + (f.to || "?");
  }

  // LÃ¤ngster Flug: Route + StÃ¤dtezeile + Distanz/Zeit
  if (longestRouteEl)  longestRouteEl.textContent  = routeLabel(longest);
  if (longestDescEl && longest) {
    const fromCity = cityName(longest.from);
    const toCity   = cityName(longest.to);
    longestDescEl.innerHTML = `
      <div class="city-line">${fromCity} \u2192 ${toCity}</div>
      ${Math.round(longest.distanceKm)} km, ${formatHours(longest.durationHours)}
    `;
  }

  // KÃ¼rzester Flug: Route + StÃ¤dtezeile + Distanz/Zeit
  if (shortestRouteEl) shortestRouteEl.textContent = routeLabel(shortest);
  if (shortestDescEl && shortest) {
    const fromCity = cityName(shortest.from);
    const toCity   = cityName(shortest.to);
    shortestDescEl.innerHTML = `
      <div class="city-line">${fromCity} \u2192 ${toCity}</div>
      ${Math.round(shortest.distanceKm)} km, ${formatHours(shortest.durationHours)}
    `;
  }

  // --- HÃ¤ufigste Route (mit from/to + count) ---
  let frequent = null;
  const routeStats = {};

  flights.forEach(f => {
    if (!f.from || !f.to) return;
    const key = f.from + " \u2192 " + f.to;
    if (!routeStats[key]) {
      routeStats[key] = { from: f.from, to: f.to, count: 0 };
    }
    routeStats[key].count++;
    if (!frequent || routeStats[key].count > frequent.count) {
      frequent = routeStats[key];
    }
  });

  if (frequent) {
    const routeKey = frequent.from + " \u2192 " + frequent.to;
    if (mostRouteEl)      mostRouteEl.textContent      = routeKey;
    if (mostRouteCountEl) {
      const fromCity = cityName(frequent.from);
      const toCity   = cityName(frequent.to);
      mostRouteCountEl.innerHTML = `
        <div class="city-line">${fromCity} \u2192 ${toCity}</div>
        ${frequent.count}x geflogen
      `;
    }
  } else {
    if (mostRouteEl)      mostRouteEl.textContent      = "â€“";
    if (mostRouteCountEl) mostRouteCountEl.textContent = "";
  }
}

function renderDashboardTopCards(flights) {
  const topMain = document.getElementById("dashTopAirlineMain");
  const topSub  = document.getElementById("dashTopAirlineSub");
  const topMeta = document.getElementById("dashTopAirlineMeta");

  const lastMain = document.getElementById("dashLastFlightMain");
  const lastSub  = document.getElementById("dashLastFlightSub");
  const lastMeta = document.getElementById("dashLastFlightMeta");

  if (!topMain || !topSub || !lastMain || !lastSub) return;

  if (!flights.length) {
    topMain.textContent = "â€“";
    topSub.textContent = "";
    if (topMeta) topMeta.textContent = "";

    lastMain.textContent = "â€“";
    lastSub.textContent = "";
    if (lastMeta) lastMeta.textContent = "";
    return;
  }

  // --- Meistgeflogene Airline ---
  const airlineCounts = countOccurrences(flights, f => (f.airline || "").trim() || null);
  const sortedAirlines = sortedEntries(airlineCounts);
  const topAirlineEntry = sortedAirlines.length ? sortedAirlines[0] : null;

  if (topAirlineEntry) {
    const [airlineName, count] = topAirlineEntry;

    // Logo groÃŸ erzwingen (Inline-Style = unkaputtbar)
    const logoHtml = renderAirlineLogo(airlineName)
      .replace("<img ", "<img style=\"height:44px;width:auto;vertical-align:middle;\" ");

    topMain.innerHTML = `${logoHtml} <span style="margin-left:10px;vertical-align:middle;">${airlineName}</span>`;
    topSub.textContent = `${count} Flug${count===1 ? "" : "e"} mit dieser Airline`;
    if (topMeta) topMeta.textContent = "";
  } else {
    topMain.textContent = "â€“";
    topSub.textContent = "Keine Airline-Daten";
    if (topMeta) topMeta.textContent = "";
  }

  // --- Letzter Flug ---
  const flightsWithDate = flights
    .filter(f => f.date && !isNaN(new Date(f.date)))
    .sort((a,b)=> new Date(a.date) - new Date(b.date));
  const last = flightsWithDate.length ? flightsWithDate[flightsWithDate.length-1] : null;

  function airportLabel(code) {
    const a = AIRPORTS[code];
    return a ? (a.city || code) + " (" + code + ")" : (code || "â€“");
  }

  if (last) {
    lastMain.textContent = `${last.from} â†’ ${last.to}`;
    lastSub.innerHTML = `<div class="city-line">${cityName(last.from)} â†’ ${cityName(last.to)}</div>`;
    if (lastMeta) {
      const parts = [];
      if (last.airline)  parts.push("Airline: " + last.airline);
      if (last.aircraft) parts.push("Aircraft: " + last.aircraft);
      if (last.durationHours) parts.push("Dauer: " + formatHours(last.durationHours));
      lastMeta.textContent = parts.join(" Â· ");
    }
  } else {
    lastMain.textContent = "â€“";
    lastSub.textContent = "Kein letzter Flug";
    if (lastMeta) lastMeta.textContent = "";
  }
}

function cityName(code) {
  const a = AIRPORTS[code];
  return a ? (a.city || code) : code;
}

function renderDashboardTiles() {
  console.log("renderDashboardTiles() called");

  const wrap = document.getElementById("dashboardTiles");
  console.log("dashboardTiles:", wrap);
  if (!wrap) return;

  // nie "leer" wirken lassen
  wrap.innerHTML = `<div class="muted">Dashboard lÃ¤dtâ€¦</div>`;

  try {
    const flightsAll = loadFlights();
    const year = (typeof getSelectedYear === "function") ? getSelectedYear() : null;

    const scoped = year
      ? flightsAll.filter(f => {
          const d = new Date(f.date);
          return !isNaN(d) && d.getFullYear() === year;
        })
      : flightsAll;

    const tripFilter = localStorage.getItem("dash_tripType"); // "p" | "g" | null
    const flights = tripFilter ? scoped.filter(f => f.tripType === tripFilter) : scoped;

    const scopeLabel = year ? `Jahr ${year}` : "Alle Jahre";
    const typeLabel  = tripFilter ? (tripFilter === "g" ? "ğŸ’¼ GeschÃ¤ft" : "ğŸ Privat") : "";

    // Empty State (wichtig: sonst wirktâ€™s "leer")
    if (!flights.length) {
      wrap.innerHTML = `
        <div class="stat-card tile tile-full">
          <div class="stat-label">â„¹ï¸ Keine FlÃ¼ge</div>
          <div class="stat-value">${scopeLabel}${typeLabel ? " Â· " + typeLabel : ""}</div>
          <div class="stat-note">Importiere deine Flights-CSV oder erfasse einen Flug.</div>
        </div>
      `;
      return;
    }

    // --- KPIs ---
    const totalKm = flights.reduce((s,f)=>s+(f.distanceKm||0),0);
    const totalHours = flights.reduce((s,f)=>s+(f.durationHours||0),0);

    const airportsSet = new Set();
    const airlinesSet = new Set();
    flights.forEach(f=>{
      if (AIRPORTS?.[f.from]) airportsSet.add(f.from);
      if (AIRPORTS?.[f.to])   airportsSet.add(f.to);
      const a = (f.airline||"").trim();
      if (a) airlinesSet.add(a);
    });

    const countriesSet = new Set();
    airportsSet.forEach(code=>{
      const c = (AIRPORTS?.[code]?.country || "").toUpperCase();
      if (c && c.length === 2) countriesSet.add(c);
    });

    // --- Highlights ---
    const flightsWithDist = flights.filter(f=>f.distanceKm);
    const longest = flightsWithDist.length ? [...flightsWithDist].sort((a,b)=>b.distanceKm-a.distanceKm)[0] : null;
    const shortest = flightsWithDist.length ? [...flightsWithDist].sort((a,b)=>a.distanceKm-b.distanceKm)[0] : null;

    const routeCounts = countOccurrences(flights, f => (f.from && f.to) ? `${f.from} â†’ ${f.to}` : null);
    const topRoute = sortedEntries(routeCounts)[0] || null;

    const airlineCounts = countOccurrences(flights, f => (f.airline||"").trim() || null);
    const topAirline = sortedEntries(airlineCounts)[0] || null;

// Airport visits (hin+rÃ¼ck = 1 Besuch)
const movement = {};
flights.forEach(f=>{
  const from = String(f.from || "").trim().toUpperCase();
  const to   = String(f.to   || "").trim().toUpperCase();
  if (from) movement[from] = (movement[from] || 0) + 1;
  if (to)   movement[to]   = (movement[to]   || 0) + 1;
});

const visits = {};
Object.entries(movement).forEach(([k,v])=>{
  visits[k] = Math.ceil(v / 2);
});

const homeAirport = getHomeAirportIata();

// Debug (einmal checken)
console.log("Home airport:", homeAirport);
console.log("Top 5 visits (raw):", Object.entries(visits).sort((a,b)=>b[1]-a[1]).slice(0,5));

// Top Airport OHNE Home Airport
const topAirport = Object.entries(visits)
  .filter(([iata]) => {
  const code = String(iata || "").trim().toUpperCase();
  return code && code !== homeAirport;
})

  .sort((a,b)=>b[1]-a[1])[0] || null;

console.log("Top airport (filtered):", topAirport);

    const airportCity = (code) => AIRPORTS?.[code]?.city || "";
    const airportLabel = (code) => AIRPORTS?.[code] ? `${airportCity(code)} (${code})` : code;

    // --- Recent ---
    const sortedByDate = [...flights].filter(f=>f.date).sort((a,b)=>new Date(b.date)-new Date(a.date));
    const recent = sortedByDate.slice(0,5);

    // --- Month Bars ---
    const yearNow = new Date().getFullYear();
    const barsYear = year || yearNow;
    const buckets = Array.from({length:12}, ()=>0);
    flights.forEach(f=>{
      const d=new Date(f.date);
      if (isNaN(d) || d.getFullYear()!==barsYear) return;
      buckets[d.getMonth()] += (f.distanceKm||0);
    });
    const max = Math.max(...buckets, 1);

    // Hilfsfunktion: Route "ZRH â†’ JFK" sauber parsen
    function parseRouteKey(routeKey){
      const parts = String(routeKey).split("â†’").map(s=>s.trim());
      return { from: parts[0] || "", to: parts[1] || "" };
    }

    // ======= Render =======
    wrap.innerHTML = `
      <div class="stat-card tile tile-full">
        <div class="stat-label">ğŸ§­ Bereich</div>
        <div class="stat-value">${scopeLabel}${typeLabel ? " Â· " + typeLabel : ""}</div>
        <div class="stat-note">Dashboard zeigt immer den aktuell gewÃ¤hlten Filter.</div>
      </div>

      <div class="stat-card tile"><div class="stat-label">âœˆï¸ FlÃ¼ge</div><div class="stat-value">${flights.length}</div></div>
      <div class="stat-card tile"><div class="stat-label">ğŸ“ Km</div><div class="stat-value">${Math.round(totalKm).toLocaleString()}</div></div>
      <div class="stat-card tile"><div class="stat-label">â± Zeit</div><div class="stat-value">${formatHours(totalHours)}</div><div class="stat-note">${hoursToText(totalHours)}</div></div>
      <div class="stat-card tile"><div class="stat-label">ğŸ›¬ Airports</div><div class="stat-value">${airportsSet.size}</div></div>
      <div class="stat-card tile"><div class="stat-label">ğŸ›« Airlines</div><div class="stat-value">${airlinesSet.size}</div></div>
      <div class="stat-card tile"><div class="stat-label">ğŸŒ LÃ¤nder</div><div class="stat-value">${countriesSet.size}</div></div>

      <div class="stat-card tile">
        <div class="stat-label">ğŸ” LÃ¤ngster Flug</div>
        <div class="stat-value">${longest  ? `${airportCodeWithFlag(longest.from)} â†’ ${airportCodeWithFlag(longest.to)}` : "â€“"}</div>
		<div class="stat-note"> ${longest  ? `${airportCityLabel(longest.from)} â†’ ${airportCityLabel(longest.to)} Â· ${Math.round(longest.distanceKm)} km` : ""}</div>
      </div>

      <div class="stat-card tile">
        <div class="stat-label">ğŸ§Š KÃ¼rzester Flug</div>
        <div class="stat-value">${shortest ? `${airportCodeWithFlag(shortest.from)} â†’ ${airportCodeWithFlag(shortest.to)}` : "â€“"}</div>
        <div class="stat-note">${shortest  ? `${airportCityLabel(shortest.from)} â†’ ${airportCityLabel(shortest.to)} Â· ${Math.round(shortest.distanceKm)} km` : ""}</div>
      </div>

      <div class="stat-card tile">
        <div class="stat-label">ğŸ” HÃ¤ufigste Route</div>
        <div class="stat-value">${topRoute  ? (() => {
        const [from,to] = topRoute[0].split("â†’").map(s=>s.trim());
        return `${airportCodeWithFlag(from)} â†’ ${airportCodeWithFlag(to)}`;
      })()    : "â€“"}</div>
       <div class="stat-note">${topRoute  ? (() => {
        const [from,to] = topRoute[0].split("â†’").map(s=>s.trim());
        return `${airportCityLabel(from)} â†’ ${airportCityLabel(to)} Â· ${topRoute[1]}Ã—`;
      })()  : ""}</div>
      </div>

      <div class="stat-card tile">
        <div class="stat-label">ğŸ† Top Airline</div>
        <div class="stat-value">${ topAirline ? `${(typeof renderAirlineLogo==="function") ? renderAirlineLogo(topAirline[0]) : ""} <span style="margin-left:8px">${topAirline[0]}</span>` : "â€“"}</div>
        <div class="stat-note">${topAirline ? `${topAirline[1]}Ã—` : ""}</div>
      </div>

      <div class="stat-card tile">
        <div class="stat-label">ğŸ›¬ Top Airport</div>
        <div class="stat-value">${topAirport ? airportCodeWithFlag(topAirport[0]) : "â€“"}</div>
        <div class="stat-note">${topAirport ? `${airportCityLabel(topAirport[0])} Â· ${topAirport[1]} Besuche` : ""}</div>

      </div>

      <div class="stat-card tile tile-full">
        <div class="stat-label">âš¡ Quick Actions</div>
        <div class="dash-actions">
          <button class="btn btn-primary btn-sm" type="button" id="dashGoAdd">â• Neuer Flug</button>
          <button class="btn btn-secondary btn-sm" type="button" id="dashThisYear">ğŸ“… ${yearNow}</button>
          <button class="btn btn-secondary btn-sm" type="button" id="dashPriv">ğŸ Privat</button>
          <button class="btn btn-secondary btn-sm" type="button" id="dashBiz">ğŸ’¼ GeschÃ¤ft</button>
          <button class="btn btn-secondary btn-sm" type="button" id="dashClearFilters">ğŸ§¹ Reset</button>
        </div>
        <div class="stat-note" style="margin-top:.35rem;">Tip: Privat/GeschÃ¤ft wirkt nur fÃ¼rs Dashboard.</div>
      </div>

      <div class="stat-card tile tile-full">
        <div class="stat-label">ğŸ§¾ Zuletzt geflogen</div>
        <div class="dash-recent">
          ${recent.map(f=>{
            const logo = (typeof renderAirlineLogo==="function") ? renderAirlineLogo((f.airline||"").trim()) : "";
            const typ = f.tripType==="g" ? "ğŸ’¼" : "ğŸ";
            return `
              <div class="recent-card">
                <div class="recent-top">
                  <div class="recent-route">${f.from} â†’ ${f.to}</div>
                  <div style="display:flex;align-items:center;gap:.35rem;">${logo}<span>${typ}</span></div>
                </div>
                <div class="recent-sub">${formatDate(f.date)} Â· ${airportLabel(f.from)} â†’ ${airportLabel(f.to)}</div>
              </div>
            `;
          }).join("")}
        </div>
      </div>

      <div class="stat-card tile tile-full">
        <div class="stat-label">ğŸ“† Km pro Monat</div>
        <div class="stat-note">${year ? `${year}` : `${barsYear} (bei â€Alle Jahreâ€œ zeigen wir das aktuelle Jahr)`}</div>
        <div class="dash-bars">
          ${buckets.map((km,i)=>{
            const h = Math.round((km/max)*100);
            const px = Math.max(6, Math.round(h*0.72));
            return `
              <div style="flex:1;">
                <div class="dash-bar-wrap">
  <div class="dash-bar"
       data-km="${Math.round(km)} km"
       style="height:${px}px;">
  </div>
</div>

                <div class="dash-bar-label">${String(i+1).padStart(2,"0")}</div>
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `;

    // ======= Actions wiring =======
    document.getElementById("dashGoAdd")?.addEventListener("click", () => {
      window.showPage?.("flightsPage");
      setTimeout(()=>document.getElementById("flightFormCard")?.scrollIntoView({behavior:"smooth"}), 120);
    });

    document.getElementById("dashThisYear")?.addEventListener("click", () => {
      const ys = document.getElementById("yearSelect");
      if (ys) ys.value = String(yearNow);
      renderAll?.();
      renderDashboard?.();
    });

    document.getElementById("dashPriv")?.addEventListener("click", () => {
      localStorage.setItem("dash_tripType", "p");
      renderDashboard?.();
    });

    document.getElementById("dashBiz")?.addEventListener("click", () => {
      localStorage.setItem("dash_tripType", "g");
      renderDashboard?.();
    });

    document.getElementById("dashClearFilters")?.addEventListener("click", () => {
      localStorage.removeItem("dash_tripType");
      renderDashboard?.();
    });

  } catch (err) {
    console.error("Dashboard render error:", err);
    wrap.innerHTML = `<div class="error">Dashboard Fehler: ${err.message}</div>`;
  }
}

function renderDashboard(){
  renderDashboardTiles();
}

function animateNumber(el, to, durationMs) {
  const start = 0;
  const startTime = performance.now();
  const target = Number(to) || 0;

  function frame(now) {
    const elapsed = now - startTime;
    const t = Math.min(1, elapsed / durationMs);
    const value = start + (target - start) * t;
    el.textContent = Math.round(value).toLocaleString();

    if (t < 1) {
      requestAnimationFrame(frame);
    }
  }

  requestAnimationFrame(frame);
}

function animateKpiNumbers() {
  const els = document.querySelectorAll("#dashboardKpis .stat-value[data-animate]");
  els.forEach(el => {
    const target = el.getAttribute("data-animate");
    animateNumber(el, target, 800); // ~0.8s Animation
  });
}

function renderDashboardHighlights(flights) {
  const topEl  = document.getElementById("highlightTopAirline");
  const lastEl = document.getElementById("highlightLastFlight");
  if (!topEl && !lastEl) return;

  if (!flights.length) {
    if (topEl)  topEl.innerHTML  = "<span class=\"muted\">Noch keine Fl&uuml;ge erfasst.</span>";
    if (lastEl) lastEl.innerHTML = "<span class=\"muted\">Noch keine Fl&uuml;ge erfasst.</span>";
    return;
  }

  // meistgeflogene Airline
  const airlineCounts = countOccurrences(flights, f => {
    const a = (f.airline || "").trim();
    return a || null;
  });
  const sortedAirlines = sortedEntries(airlineCounts);
  const topAirlineEntry = sortedAirlines.length ? sortedAirlines[0] : null;

  // letzter Flug
  const flightsWithDate = flights
    .filter(f => f.date && !isNaN(new Date(f.date)))
    .sort((a,b)=> new Date(a.date) - new Date(b.date));
  const lastFlight = flightsWithDate.length
    ? flightsWithDate[flightsWithDate.length-1]
    : null;

  function airportLabel(code) {
    const a = AIRPORTS[code];
    return a ? (a.city || code) + " (" + code + ")" : code || "â€“";
  }

  // Karte: Meistgeflogene Airline
  if (topEl) {
    if (topAirlineEntry) {
      const [airlineName, count] = topAirlineEntry;
      topEl.innerHTML = `
  <div class="detail-main airline-hero">
    ${renderAirlineLogo(airlineName)}
    <span>${airlineName}</span>
  </div>
  <div class="detail-sub">
    ${count} Flug${count === 1 ? "" : "e"} mit dieser Airline
  </div>
`;
    } else {
      topEl.innerHTML = "<span class=\"muted\">Keine Airline-Daten verf&uuml;gbar.</span>";
    }
  }

  // Karte: Letzter Flug
  if (lastEl) {
    if (lastFlight) {
      lastEl.innerHTML = `
        <div class="detail-main">
          ${formatDate(lastFlight.date)} â€“ 
          ${airportLabel(lastFlight.from)} &rarr; ${airportLabel(lastFlight.to)}
        </div>
        <div class="detail-sub">
          ${lastFlight.airline ? "Airline: "+lastFlight.airline+" Â· " : ""}
          ${lastFlight.aircraft ? "Aircraft: "+lastFlight.aircraft+" Â· " : ""}
          ${lastFlight.durationHours ? "Dauer: "+formatHours(lastFlight.durationHours) : ""}
        </div>
      `;
    } else {
      lastEl.innerHTML = "<span class=\"muted\">Kein letzter Flug bestimmbar.</span>";
    }
  }
}

function renderDashboardLogbook(flights) {
  const logEl = document.getElementById("dashboardLogbook");
  if (!logEl) return;

  if (!flights.length) {
    logEl.innerHTML = "<span class=\"muted\">Noch keine Fl&uuml;ge erfasst.</span>";
    return;
  }

  const flightsWithDist = flights.filter(f => f.distanceKm);
  let longest = null;
  let shortest = null;
  flightsWithDist.forEach(f => {
    if (!longest || f.distanceKm > longest.distanceKm) longest = f;
    if (!shortest || f.distanceKm < shortest.distanceKm) shortest = f;
  });

  // Meistgeflogene Route (alle Jahre)
  const routeCounts = countOccurrences(flights, f => {
    if (!f.from || !f.to) return null;
    return f.from + " \u2192 " + f.to;
  });
  const sortedRoutes = sortedEntries(routeCounts);
  const topRouteEntry = sortedRoutes.length ? sortedRoutes[0] : null;

  function airportLabel(code) {
    const a = AIRPORTS[code];
    return a ? (a.city || code) + " (" + code + ")" : code;
  }

  let html = "<div class=\"muted\"><ul style=\"padding-left:1.1rem; margin:0;\">";
  if (longest) {
    html += "<li><b>L&auml;ngster Flug (gesamt):</b> "+
      formatDate(longest.date)+" â€“ "+
      airportLabel(longest.from)+" \u2192 "+airportLabel(longest.to)+
      " ("+formatKm(longest.distanceKm)+", "+formatHours(longest.durationHours)+")</li>";
  }
  if (shortest) {
    html += "<li><b>K&uuml;rzester Flug (gesamt):</b> "+
      formatDate(shortest.date)+" â€“ "+
      airportLabel(shortest.from)+" \u2192 "+airportLabel(shortest.to)+
      " ("+formatKm(shortest.distanceKm)+", "+formatHours(shortest.durationHours)+")</li>";
  }
  if (topRouteEntry) {
    const [routeKey,count] = topRouteEntry;
    html += "<li><b>Meistgeflogene Route (gesamt):</b> "+routeKey+" ("+count+"x)</li>";
  }
  html += "</ul></div>";

  logEl.innerHTML = html;
}

function renderDashboardLogbook(flights) {
  const logEl = document.getElementById("dashboardLogbook");
  if (!logEl) return;

  if (!flights.length) {
    logEl.innerHTML = "<span class=\"muted\">Noch keine Fl&uuml;ge erfasst.</span>";
    return;
  }

  // lÃ¤ngster / kÃ¼rzester Flug nach Distanz
  const flightsWithDist = flights.filter(f => f.distanceKm);
  let longest = null;
  let shortest = null;
  flightsWithDist.forEach(f => {
    if (!longest || f.distanceKm > longest.distanceKm) longest = f;
    if (!shortest || f.distanceKm < shortest.distanceKm) shortest = f;
  });

  // Meistgeflogene Route (alle Jahre)
  const routeCounts = countOccurrences(flights, f => {
    if (!f.from || !f.to) return null;
    return f.from + " \u2192 " + f.to;
  });
  const sortedRoutes = sortedEntries(routeCounts);
  const topRouteEntry = sortedRoutes.length ? sortedRoutes[0] : null;

  function airportLabel(code) {
    const a = AIRPORTS[code];
    return a ? (a.city || code) + " (" + code + ")" : code;
  }

  let html = "<div class=\"muted\"><ul style=\"padding-left:1.1rem; margin:0;\">";
  if (longest) {
    html += "<li><b>L&auml;ngster Flug (gesamt):</b> "+
      formatDate(longest.date)+" â€“ "+
      airportLabel(longest.from)+" \u2192 "+airportLabel(longest.to)+
      " ("+formatKm(longest.distanceKm)+", "+formatHours(longest.durationHours)+")</li>";
  }
  if (shortest) {
    html += "<li><b>K&uuml;rzester Flug (gesamt):</b> "+
      formatDate(shortest.date)+" â€“ "+
      airportLabel(shortest.from)+" \u2192 "+airportLabel(shortest.to)+
      " ("+formatKm(shortest.distanceKm)+", "+formatHours(shortest.durationHours)+")</li>";
  }
  if (topRouteEntry) {
    const [routeKey,count] = topRouteEntry;
    html += "<li><b>Meistgeflogene Route (gesamt):</b> "+routeKey+" ("+count+"x)</li>";
  }
  html += "</ul></div>";

  logEl.innerHTML = html;
}

 function renderFullStatistics() {
  const flights = loadFlights();
  const year = getSelectedYear();
  const flightsYear = year
    ? flights.filter(f => { const d = new Date(f.date); return !isNaN(d)&&d.getFullYear()===year; })
    : flights;

  // --- Gesamtstatistik (alle Jahre) ---
  const totalKmAll = flights.reduce((s,f)=>s+(f.distanceKm||0),0);
  const totalHoursAll = flights.reduce((s,f)=>s+(f.durationHours||0),0);
  const allAirportsSet = new Set();
  flights.forEach(f=>{
    if (AIRPORTS[f.from]) allAirportsSet.add(f.from);
    if (AIRPORTS[f.to])   allAirportsSet.add(f.to);
  });
  const allAirlinesSet = new Set(flights.map(f=> (f.airline||"").trim()).filter(Boolean));
  const allAircraftSet = new Set(flights.map(f=> (f.aircraft||"").trim()).filter(Boolean));
  
  const countrySet = new Set();
flights.forEach(f => {
  const from = AIRPORTS[f.from];
  const to   = AIRPORTS[f.to];
  if (from?.country) countrySet.add(from.country.toUpperCase());
  if (to?.country)   countrySet.add(to.country.toUpperCase());
});

  document.getElementById("statsAllYears").innerHTML =
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ“</span>Total Km</div><div class=\"stat-value\">"+totalKmAll.toLocaleString()+"</div></div>"+
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ›£</span>Total Miles</div><div class=\"stat-value\">"+Math.round(totalKmAll*0.621371).toLocaleString()+"</div></div>"+
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">â±</span>Total Zeit</div><div class=\"stat-value\">"+formatHours(totalHoursAll)+"</div><div class=\"stat-note\">"+hoursToText(totalHoursAll)+"</div></div>"+
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">âœˆï¸</span>Fl&uuml;ge</div><div class=\"stat-value\">"+flights.length+"</div></div>"+
	"<div class='stat-card'>" +  "<div class='stat-label'>ğŸŒ LÃ¤nder</div>" +  "<div class='stat-value'>" + countrySet.size + "</div>" +"</div>"+
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ›¬</span>Different Airports</div><div class=\"stat-value\">"+allAirportsSet.size+"</div></div>"+
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ›«</span>Different Airlines</div><div class=\"stat-value\">"+allAirlinesSet.size+"</div></div>"+
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ›©</span>Different Aircrafts</div><div class=\"stat-value\">"+allAircraftSet.size+"</div></div>";

  // --- Statistik fÃ¼r gewÃ¤hltes Jahr bzw. alle ---
  const totalKmYear = flightsYear.reduce((s,f)=>s+(f.distanceKm||0),0);
  const totalHoursYear = flightsYear.reduce((s,f)=>s+(f.durationHours||0),0);
  document.getElementById("statsSelectedYear").innerHTML =
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ“…</span>Bereich</div><div class=\"stat-value\">"+(year ?? "Alle Jahre")+"</div></div>"+
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ“</span>Km</div><div class=\"stat-value\">"+totalKmYear.toLocaleString()+"</div></div>"+
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ›£</span>Miles</div><div class=\"stat-value\">"+Math.round(totalKmYear*0.621371).toLocaleString()+"</div></div>"+
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">â±</span>Zeit</div><div class=\"stat-value\">"+formatHours(totalHoursYear)+"</div><div class=\"stat-note\">"+hoursToText(totalHoursYear)+"</div></div>"+
    "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">âœˆï¸</span>Fl&uuml;ge</div><div class=\"stat-value\">"+flightsYear.length+"</div></div>";

  // --- FlughÃ¤fen / Airlines / Aircrafts fÃ¼r den gewÃ¤hlten Bereich ---
  const airportFrom = countOccurrences(flightsYear, f => {
    const a = AIRPORTS[f.from];
    return a ? (a.city || f.from) + " (" + f.from + ")" : null;
  });
  const airportTo = countOccurrences(flightsYear, f => {
    const a = AIRPORTS[f.to];
    return a ? (a.city || f.to) + " (" + f.to + ")" : null;
  });
  const mergedAirports = {};
  for (const [k,v] of Object.entries(airportFrom)) mergedAirports[k] = (mergedAirports[k]||0)+v;
  for (const [k,v] of Object.entries(airportTo)) mergedAirports[k] = (mergedAirports[k]||0)+v;

  // Hin- und RÃ¼ckflug als 1 Besuch
  const visitCounts = {};
  for (const [k,v] of Object.entries(mergedAirports)) {
    visitCounts[k] = Math.ceil(v / 2);
  }
  const sortedAirports = sortedEntries(visitCounts);

  const airlinesCounts = countOccurrences(flightsYear, f => (f.airline||"").trim() || null);
  const sortedAirlines = sortedEntries(airlinesCounts);

  const aircraftCounts = countOccurrences(flightsYear, f => (f.aircraft||"").trim() || null);
  const sortedAircrafts = sortedEntries(aircraftCounts);

  document.getElementById("statsAirlines").innerHTML =
  buildRankBarsExpandable(sortedAirlines, 10, {
    withSearch: true,
    searchPlaceholder: "Airline suchenâ€¦",
    renderNameHtml: (name) => `${renderAirlineLogo(name)} <span style="margin-left:8px">${name}</span>`
  });

  document.getElementById("statsAirports").innerHTML =
  buildRankBarsExpandable(sortedAirports, 10, {
    withSearch: true,
    searchPlaceholder: "Airport suchenâ€¦",
    renderNameHtml: (name) => {
      // name ist bei dir "Stadt (IATA)" â†’ IATA herausziehen:
      const m = /\(([A-Z]{3})\)\s*$/.exec(name);
      const iata = m ? m[1] : name.trim();
      return renderAirportWithFlag(iata);

    }
  });

  document.getElementById("statsAircrafts").innerHTML =
  buildRankBarsExpandable(sortedAircrafts, 10, { searchPlaceholder: "Flugzeugtyp suchenâ€¦" });

  const sortedCountries = computeCountryCounts(flightsYear);
document.getElementById("statsCountries").innerHTML =
  buildRankBarsExpandable(sortedCountries, 10, {
    withSearch: true,
    searchPlaceholder: "Land suchenâ€¦",
    renderNameHtml: (iso2) => `
      ${renderFlagImg(iso2)}
      <span class="country-code">${iso2}</span>
    `
  });

wireRankTogglesAndSearch();

  document.getElementById("topAirports").innerHTML  = buildStatsTable(sortedAirports.slice(0,5));
  document.getElementById("topAirlines").innerHTML  = buildStatsTable(sortedAirlines.slice(0,5));
  document.getElementById("topAircrafts").innerHTML = buildStatsTable(sortedAircrafts.slice(0,5));

  // Karte fÃ¼r den Bereich
  setTimeout(()=>renderMap(flightsYear),100);
}

  // ----- Rendering Hauptseite -----

  // Airline-Logo oder Text anzeigen
  function renderAirlineLogo(name) {
    if (!name) return "â€“";
    const raw = name.trim();
    if (!raw) return "â€“";

    const key = raw.toUpperCase();          // wir matchen gegen GROSSSCHRIFT
    const url = AIRLINE_LOGOS[key];

    // kein Logo hinterlegt? -> Text anzeigen
    if (!url) {
      return raw;
    }

    // Logo mit Tooltip
    return `<img src="${url}" alt="${raw}" title="${raw}"
                style="height:20px; max-width:70px; object-fit:contain; vertical-align:middle;">`;
  }

  function renderFlightsTable(visibleFlights) {
    const tbody = document.getElementById("flightTableBody");
    tbody.innerHTML = "";
    visibleFlights.forEach((f, idx) => {
      const fromA = AIRPORTS[f.from] || {};
      const toA = AIRPORTS[f.to] || {};
      const tripLabel = f.tripType === "g"
        ? "<span class=\"trip-badge trip-geschaeft\"><span class=\"icon\">ğŸ’¼</span>Gesch&auml;ft</span>"
        : f.tripType === "p"
          ? "<span class=\"trip-badge trip-privat\"><span class=\"icon\">ğŸ</span>Privat</span>"
          : "<span class=\"trip-badge\">â€“</span>";
      const tr = document.createElement("tr");
      tr.innerHTML =
        "<td>"+(idx+1)+"</td>"+
        "<td>"+formatDate(f.date)+"</td>"+
        "<td><div><span class=\"tag\"><span class=\"icon\">ğŸ›«</span>"+f.from+"</span></div><div class=\"muted\">"+(fromA.city || "")+"</div></td>"+
        "<td><div><span class=\"tag\"><span class=\"icon\">ğŸ›¬</span>"+f.to+"</span></div><div class=\"muted\">"+(toA.city || "")+"</div></td>"+
        "<td>"+renderAirlineLogo(f.airline)+"</td>"+
        "<td>"+(f.aircraft || "â€“")+"</td>"+
        "<td>"+formatKm(f.distanceKm)+"<br><span class=\"muted\">"+formatMiles(f.distanceKm)+"</span></td>"+
        "<td>"+formatHours(f.durationHours)+"</td>"+
        "<td>"+tripLabel+"</td>"+
        "<td class=\"row-actions\">" +
			"<button class=\"action-btn\" title=\"Bearbeiten\" aria-label=\"Bearbeiten\" data-edit-id=\""+f.id+"\">âœï¸</button>" +
			"<button class=\"action-btn danger\" title=\"LÃ¶schen\" aria-label=\"LÃ¶schen\" data-id=\""+f.id+"\">ğŸ—‘ï¸</button>" +
			"</td>";

      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("button[data-delete-id]").forEach(btn => {
      btn.addEventListener("click", () => {
        deleteFlight(btn.getAttribute("data-delete-id"));
      });
    });
    tbody.querySelectorAll("button[data-edit-id]").forEach(btn => {
      btn.addEventListener("click", () => {
        startEditFlight(btn.getAttribute("data-edit-id"));
      });
    });

    document.getElementById("visibleCount").innerHTML =
      "<span class=\"icon\">ğŸ‘€</span>"+visibleFlights.length+" sichtbar";
	
	const empty = document.getElementById("flightsEmptyState");
if (empty) {
  if (!visibleFlights.length) {
    empty.style.display = "block";
    empty.innerHTML = `
      <div class="empty-title">Keine FlÃ¼ge gefunden</div>
      <div class="muted">Suchbegriff/Filter liefern keine Treffer.</div>
      <div class="empty-actions">
        <button class="btn btn-secondary btn-sm" type="button" id="resetFiltersBtn">Filter zurÃ¼cksetzen</button>
        <button class="btn btn-primary btn-sm" type="button" id="scrollToAddFlightBtn">+ Flug hinzufÃ¼gen</button>
      </div>
    `;

    const rf = document.getElementById("resetFiltersBtn");
    if (rf) rf.onclick = () => {
      document.getElementById("searchInput").value = "";
      document.getElementById("yearSelect").value = "";
      renderAll();
    };

    const sa = document.getElementById("scrollToAddFlightBtn");
    if (sa) sa.onclick = () => {
      const card = document.getElementById("addFlightCard") || document.getElementById("flightDate")?.closest(".card");
      if (card) card.scrollIntoView({ behavior: "smooth", block: "start" });
    };
  } else {
    empty.style.display = "none";
    empty.innerHTML = "";
  }
}
  }

  function renderSummary(flights, visibleFlights) {
    const year = getSelectedYear();
    document.getElementById("summaryYearLabel").textContent = year ? year : "Alle Jahre";

    const statMilesEl = document.getElementById("statMiles");
    const statKmEl = document.getElementById("statKm");
    const statHoursEl = document.getElementById("statHours");
    const statHoursTextEl = document.getElementById("statHoursText");
    const statPgEl = document.getElementById("statPg");
    const statAirlinesEl = document.getElementById("statAirlines");
    const statAircraftsEl = document.getElementById("statAircrafts");
    const flightCountLabel = document.getElementById("flightCountLabel");

    const totalKm = visibleFlights.reduce((s,f)=> s + (f.distanceKm||0), 0);
    const totalHours = visibleFlights.reduce((s,f)=> s + (f.durationHours||0), 0);
    const totalFlights = visibleFlights.length;
    const priv = visibleFlights.filter(f=>f.tripType==="p").length;
    const gesch = visibleFlights.filter(f=>f.tripType==="g").length;

    const airlines = new Set(visibleFlights.map(f => (f.airline||"").trim()).filter(Boolean));
    const aircrafts = new Set(visibleFlights.map(f => (f.aircraft||"").trim()).filter(Boolean));

    statKmEl.textContent = totalKm ? formatKm(totalKm) : "â€“";
    statMilesEl.textContent = totalKm ? formatMiles(totalKm) : "â€“";
    statHoursEl.textContent = totalHours ? formatHours(totalHours) : "â€“";
    statHoursTextEl.textContent = totalHours ? hoursToText(totalHours) : "";
    statPgEl.innerHTML = totalFlights
      ? totalFlights+" (ğŸ "+priv+" / ğŸ’¼ "+gesch+")"
      : "â€“";
    statAirlinesEl.textContent = airlines.size ? (""+airlines.size) : "â€“";
    statAircraftsEl.textContent = aircrafts.size ? (""+aircrafts.size) : "â€“";
    flightCountLabel.innerHTML =
      "<span class=\"icon\">ğŸ§®</span>"+totalFlights + (totalFlights === 1 ? " Flug" : " Fl&uuml;ge");
  }

  function renderMiniStats(visibleFlights) {
    const miniKm = visibleFlights.reduce((s,f)=>s+(f.distanceKm||0),0);
    const miniHours = visibleFlights.reduce((s,f)=>s+(f.durationHours||0),0);
    document.getElementById("miniStats").innerHTML =
      "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ“</span>Km</div><div class=\"stat-value\">"+miniKm.toLocaleString()+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ›£</span>Meilen</div><div class=\"stat-value\">"+Math.round(miniKm*0.621371).toLocaleString()+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">â±</span>Zeit</div><div class=\"stat-value\">"+formatHours(miniHours)+"</div></div>";
  }

  function renderAll() {
    updateAirportCount();
    const flights = loadFlights();
    buildYearOptions(flights);
    const visible = applyFilters(flights);
    renderFlightsTable(visible);
    if (document.getElementById("statsPage").style.display !== "none") {
      renderFullStatistics();
    }
  }

  function renderSummary(flights, visibleFlights) {
    const year = getSelectedYear();
    document.getElementById("summaryYearLabel").textContent = year ? year : "Alle Jahre";

    const statMilesEl = document.getElementById("statMiles");
    const statKmEl = document.getElementById("statKm");
    const statHoursEl = document.getElementById("statHours");
    const statHoursTextEl = document.getElementById("statHoursText");
    const statPgEl = document.getElementById("statPg");
    const statAirlinesEl = document.getElementById("statAirlines");
    const statAircraftsEl = document.getElementById("statAircrafts");
    const flightCountLabel = document.getElementById("flightCountLabel");

    const totalKm = visibleFlights.reduce((s,f)=> s + (f.distanceKm||0), 0);
    const totalHours = visibleFlights.reduce((s,f)=> s + (f.durationHours||0), 0);
    const totalFlights = visibleFlights.length;
    const priv = visibleFlights.filter(f=>f.tripType==="p").length;
    const gesch = visibleFlights.filter(f=>f.tripType==="g").length;

    const airlines = new Set(visibleFlights.map(f => (f.airline||"").trim()).filter(Boolean));
    const aircrafts = new Set(visibleFlights.map(f => (f.aircraft||"").trim()).filter(Boolean));

    statKmEl.textContent = totalKm ? formatKm(totalKm) : "â€“";
    statMilesEl.textContent = totalKm ? formatMiles(totalKm) : "â€“";
    statHoursEl.textContent = totalHours ? formatHours(totalHours) : "â€“";
    statHoursTextEl.textContent = totalHours ? hoursToText(totalHours) : "";
    statPgEl.innerHTML = totalFlights
      ? totalFlights+" (ğŸ "+priv+" / ğŸ’¼ "+gesch+")"
      : "â€“";
    statAirlinesEl.textContent = airlines.size ? (""+airlines.size) : "â€“";
    statAircraftsEl.textContent = aircrafts.size ? (""+aircrafts.size) : "â€“";
    flightCountLabel.innerHTML =
      "<span class=\"icon\">ğŸ§®</span>"+totalFlights + (totalFlights === 1 ? " Flug" : " Fl\u00fcge");
  }

  function renderMiniStats(visibleFlights) {
    const miniKm = visibleFlights.reduce((s,f)=>s+(f.distanceKm||0),0);
    const miniHours = visibleFlights.reduce((s,f)=>s+(f.durationHours||0),0);
    document.getElementById("miniStats").innerHTML =
      "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ“</span>Km</div><div class=\"stat-value\">"+miniKm.toLocaleString()+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">ğŸ›£</span>Meilen</div><div class=\"stat-value\">"+Math.round(miniKm*0.621371).toLocaleString()+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\"><span class=\"icon\">â±</span>Zeit</div><div class=\"stat-value\">"+formatHours(miniHours)+"</div></div>";
  }

  function renderAll() {
    updateAirportCount();
    const flights = loadFlights();
    buildYearOptions(flights);
    const visible = applyFilters(flights);
    renderFlightsTable(visible);
    if (document.getElementById("statsPage").style.display !== "none") {
      renderFullStatistics();
    }
  }

function wireProfileLogoTooltips(){
  const container =
    document.getElementById("profileAirlineList") ||
    document.getElementById("profileAirlineLogos");

  if (!container) return;

  if (container.dataset.tooltipWired === "1") return;
  container.dataset.tooltipWired = "1";

  container.addEventListener("pointerup", (e) => {
    const tile = e.target.closest(".logo-tile");
    if (!tile || !container.contains(tile)) return;

    container.querySelectorAll(".logo-tile.show-tooltip").forEach(t => {
      if (t !== tile) t.classList.remove("show-tooltip");
    });

    tile.classList.toggle("show-tooltip");
  });
}

  document.addEventListener("DOMContentLoaded", () => {
  // Event-Listener & Buttons
  document.getElementById("loadAirportBtn")?.addEventListener("click", handleAirportCsvLoad);
  document.getElementById("loadFlightsBtn")?.addEventListener("click", handleFlightsCsvLoad);
  document.getElementById("addFlightBtn")?.addEventListener("click", addFlight);
  document.getElementById("cancelEditBtn")?.addEventListener("click", cancelEdit);
  document.getElementById("clearAllFlightsBtn")?.addEventListener("click", clearAllFlights);
  document.getElementById("searchInput")?.addEventListener("input", renderAll);
  document.getElementById("yearSelect")?.addEventListener("change", renderAll);

  document.getElementById("resetYearBtn")?.addEventListener("click", () => {
    document.getElementById("yearSelect").value = "";
    renderAll();
    logAllAirlinesFromData();
  });

  // Pages
  const pages = {
    dashboardPage: document.getElementById("dashboardPage"),
    flightsPage:   document.getElementById("flightsPage"),
    statsPage:     document.getElementById("statsPage"),
    dataPage:      document.getElementById("dataPage"),
    profilePage:   document.getElementById("profilePage")
  };

  function showPage(targetId) {
    // show/hide
	console.log("showPage ->", targetId);
    Object.entries(pages).forEach(([id, el]) => {
      if (!el) return;
      const isActive = (id === targetId);
      el.style.display = isActive ? "block" : "none";
      el.classList.toggle("page-active", isActive);
    });

    // nav-active markieren
    document.querySelectorAll(".bottom-nav .nav-item").forEach(btn => {
      btn.classList.toggle("nav-active", btn.getAttribute("data-target") === targetId);
    });

    // Render nach Umschalten
    if (targetId === "dashboardPage") setTimeout(renderDashboardTiles, 0);
    else if (targetId === "flightsPage") setTimeout(renderAll, 0);
    else if (targetId === "statsPage") setTimeout(renderFullStatistics, 0);
    else if (targetId === "dataPage") setTimeout(updateAirportCount, 0);
    else if (targetId === "profilePage") setTimeout(renderProfile, 0);
  }

  // Klick-Handler (NUR EINMAL!)
  document.querySelectorAll(".bottom-nav .nav-item").forEach(btn => {
    btn.addEventListener("click", () => {
      showPage(btn.getAttribute("data-target"));
    });
  });

  window.showPage = showPage;

  // Start
	showPage("dashboardPage");
});

document.addEventListener("pointerup", (e) => {
  const bar = e.target.closest(".dash-bar");
  if (!bar) return;

  // andere schlieÃŸen
  document.querySelectorAll(".dash-bar.show-tooltip")
    .forEach(b => b !== bar && b.classList.remove("show-tooltip"));

  bar.classList.toggle("show-tooltip");
});

  // Klick-Handler fÃ¼r Bottom-Navigation
  document.querySelectorAll(".bottom-nav .nav-item").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-target");
      showPage(target);
    });
  });

function wireRankTogglesAndSearch() {
  // Toggle
  document.querySelectorAll("#statsPage .rank-toggle").forEach(btn => {
    btn.onclick = () => {
      const id = btn.getAttribute("data-toggle");
      const more = document.getElementById(id + "_more");
      if (!more) return;

      const isOpen = more.classList.toggle("show");
      btn.textContent = isOpen
        ? "Weniger anzeigen"
        : `Alle anzeigen (${btn.getAttribute("data-total")})`;
    };
  });

  // Search
  document.querySelectorAll("#statsPage .rank-search input[type='search']").forEach(inp => {
    inp.oninput = () => {
      const q = inp.value.trim().toLowerCase();
      const wrap = inp.closest(".card")?.querySelector(".rank-bars")?.parentElement;
      const card = inp.closest(".card");
      if (!card) return;

      // Filter alle rank-rows innerhalb dieser Card
      card.querySelectorAll(".rank-row").forEach(row => {
        const name = row.getAttribute("data-name") || "";
        row.style.display = (!q || name.includes(q)) ? "" : "none";
      });

      // Wenn Suche aktiv: "more" automatisch Ã¶ffnen, damit man auch darunter findet
      const toggle = card.querySelector(".rank-toggle");
      if (toggle) {
        const id = toggle.getAttribute("data-toggle");
        const more = document.getElementById(id + "_more");
        if (more) {
          if (q) {
            more.classList.add("show");
            toggle.textContent = "Weniger anzeigen";
          } else {
            more.classList.remove("show");
            toggle.textContent = `Alle anzeigen (${toggle.getAttribute("data-total")})`;
          }
        }
      }
    };
  });
}

const STORAGE_KEY_PROFILE = "flugmeilen_profile_v1";

function loadProfile(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY_PROFILE);
    return raw ? JSON.parse(raw) : {};
  } catch { return {}; }
}

function saveProfile(obj){
  localStorage.setItem(STORAGE_KEY_PROFILE, JSON.stringify(obj || {}));
}

function getAllAirlinesFromFlights(flights){
  const set = new Set();
  flights.forEach(f => {
    const a = (f.airline || "").trim();
    if (a) set.add(a);
  });
  return Array.from(set).sort((a,b)=>a.localeCompare(b));
}

function hasLogoForAirline(name){
  if (!name) return false;

  // wichtig: direkt AIRLINE_LOGOS verwenden, nicht window.AIRLINE_LOGOS
  if (typeof AIRLINE_LOGOS === "undefined" || !AIRLINE_LOGOS) return false;

  const key = name.trim();

  // exakt / upper / lower
  if (AIRLINE_LOGOS[key]) return true;
  if (AIRLINE_LOGOS[key.toUpperCase()]) return true;
  if (AIRLINE_LOGOS[key.toLowerCase()]) return true;

  // normalisiert vergleichen (leerzeichen/sonderzeichen ignorieren)
  const norm = key.toLowerCase().replace(/[^a-z0-9]/g, "");
  return Object.keys(AIRLINE_LOGOS).some(k =>
    k.toLowerCase().replace(/[^a-z0-9]/g, "") === norm
  );
}

function renderProfile(){
  const flights = loadFlights();
  const airlines = getAllAirlinesFromFlights(flights);

  // --- Profile form ---
  const p = loadProfile();
  const nameEl = document.getElementById("profileName");
  const homeEl = document.getElementById("homeIata");
  const speedEl = document.getElementById("defaultSpeed");
  const noteEl = document.getElementById("profileSavedNote");

  if (nameEl) nameEl.value = p.name || "";
  if (homeEl) homeEl.value = p.homeIata || "";
  if (speedEl) speedEl.value = p.defaultSpeedKmh || "";

  if (noteEl) noteEl.textContent = "";

  // --- Logos list ---
  const listEl = document.getElementById("profileAirlineList");
  const statsEl = document.getElementById("profileLogoStats");
  const searchEl = document.getElementById("profileLogoSearch");

  let onlyMissing = false;
  let query = "";

  function buildRows(){
    if (!listEl) return;
    const flights = loadFlights();

const airlineCounts = {};
const airlinePriv = {};
const airlineBiz = {};

flights.forEach(f => {
  const a = (f.airline || "").trim();
  if (!a) return;
  airlineCounts[a] = (airlineCounts[a] || 0) + 1;

  if (f.tripType === "p") airlinePriv[a] = (airlinePriv[a] || 0) + 1;
  if (f.tripType === "g") airlineBiz[a]  = (airlineBiz[a]  || 0) + 1;
});

    const filtered = airlines.filter(a => a.toLowerCase().includes(query));
    const rows = filtered.filter(a => !onlyMissing || !hasLogoForAirline(a));

    const missingCount = airlines.filter(a => !hasLogoForAirline(a)).length;
    const okCount = airlines.length - missingCount;

    if (statsEl) {
      statsEl.textContent = `âœ… ${okCount} / âŒ ${missingCount} / ğŸ”¢ ${airlines.length}`;
    }

    if (!rows.length){
      listEl.innerHTML = `<div class="muted">Keine Treffer.</div>`;
      return;
    }

    listEl.innerHTML = rows.map(a => {
  const ok = hasLogoForAirline(a);
  const logoHtml = (typeof renderAirlineLogo === "function")
    ? renderAirlineLogo(a)
    : "";

  const count = airlineCounts[a] || 0;
const p = airlinePriv[a] || 0;
const g = airlineBiz[a] || 0;

return `
  <div class="logo-tile ${ok ? "" : "missing"}" title="${a}">
    <div class="logo-status">${ok ? "âœ…" : "âŒ"}</div>

    ${renderAirlineLogo(a) || `<div style="height:44px"></div>`}

    <div class="airline-name">${a}</div>

    <div class="logo-tooltip">
      <div><b>âœˆï¸ ${count}</b> FlÃ¼ge</div>
      <div class="muted">ğŸ ${p} &nbsp;&nbsp; ğŸ’¼ ${g}</div>
    </div>
  </div>
`;
}).join("");

  }

  buildRows();

  const toggleBtn = document.getElementById("toggleMissingBtn");
  if (toggleBtn){
    toggleBtn.onclick = () => {
      onlyMissing = !onlyMissing;
      toggleBtn.innerHTML = onlyMissing
        ? `<span class="icon">ğŸ‘€</span> Alle anzeigen`
        : `<span class="icon">ğŸ•µï¸</span> Nur fehlende`;
      buildRows();
    };
  }

  if (searchEl){
    searchEl.oninput = () => {
      query = (searchEl.value || "").trim().toLowerCase();
      buildRows();
    };
  }

  // --- Save profile ---
  const saveBtn = document.getElementById("saveProfileBtn");
  if (saveBtn){
    saveBtn.onclick = () => {
      const obj = {
        name: (nameEl?.value || "").trim(),
        homeIata: (homeEl?.value || "").trim().toUpperCase(),
        defaultSpeedKmh: Number(speedEl?.value || 0) || 0
      };
      saveProfile(obj);
      if (noteEl) noteEl.textContent = "âœ… Gespeichert.";
      setTimeout(()=>{ if(noteEl) noteEl.textContent=""; }, 1500);
    };
  }

  // --- Backup / Restore ---
  const backupMsg = document.getElementById("backupMsg");

  const exportBtn = document.getElementById("exportBtn");
  if (exportBtn){
    exportBtn.onclick = () => {
      const payload = {
        exportedAt: new Date().toISOString(),
        flights: loadFlights(),
        airports: loadAirportsFromStorage ? loadAirportsFromStorage() : AIRPORTS
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "flugmeilen-backup.json";
      a.click();
      URL.revokeObjectURL(url);
      if (backupMsg) backupMsg.textContent = "â¬‡ï¸ Export erstellt.";
    };
  }

  const importFile = document.getElementById("importFile");
  if (importFile){
    importFile.onchange = () => {
      const file = importFile.files && importFile.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data.flights)) saveFlights(data.flights);
          if (data.airports && typeof data.airports === "object") {
            AIRPORTS = data.airports;
            saveAirportsToStorage();
          }
          if (backupMsg) backupMsg.textContent = "âœ… Import erledigt.";
          renderAll?.();
        } catch(err){
          if (backupMsg) backupMsg.textContent = "âŒ Import fehlgeschlagen: " + err.message;
        } finally {
          importFile.value = "";
        }
      };
      reader.readAsText(file);
    };
  }

  const resetBtn = document.getElementById("resetDataBtn");
  if (resetBtn){
    resetBtn.onclick = () => {
      if (!confirm("Wirklich ALLES lÃ¶schen? (FlÃ¼ge + Airports + Profil)")) return;
      localStorage.removeItem(STORAGE_KEY_FLIGHTS);
      localStorage.removeItem(STORAGE_KEY_AIRPORTS);
      localStorage.removeItem(STORAGE_KEY_PROFILE);
      AIRPORTS = {};
      if (backupMsg) backupMsg.textContent = "ğŸ§¨ Reset durchgefÃ¼hrt.";
      renderAll?.();
      renderProfile();
    };
  }
   wireProfileLogoTooltips();
}

</script>
<nav class="bottom-nav">
  <button class="nav-item nav-active" data-target="dashboardPage">
    <span class="nav-icon">ğŸ </span>
    <span class="nav-label">Home</span>
  </button>
  <button class="nav-item" data-target="flightsPage">
    <span class="nav-icon">âœˆï¸</span>
    <span class="nav-label">FlÃ¼ge</span>
  </button>
  <button class="nav-item" data-target="statsPage">
    <span class="nav-icon">ğŸ“Š</span>
    <span class="nav-label">Stats</span>
  </button>
  <button class="nav-item" data-target="dataPage">
    <span class="nav-icon">ğŸ› ï¸</span>
    <span class="nav-label">Daten</span>
  </button>
  <button class="nav-item" data-target="profilePage">
    <span class="nav-icon">ğŸ‘¤</span>
    <span class="nav-label">Profil</span>
  </button>
</nav>
</body>
</html>
