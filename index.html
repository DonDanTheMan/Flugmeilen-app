<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Flugmeilen Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111827" />
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

<!-- Wichtig f√ºr Android: -->
<meta name="theme-color" content="#111827">


  <!-- Leaflet f√ºr die Karte -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111827;
      background: #0b1120;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #1f2937, #020617);
      min-height: 100vh;
      color: #e5e7eb;
    }
    header {
      padding: 0.9rem 1.2rem 0.6rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }
    header small {
      color: #9ca3af;
      font-size: 0.75rem;
    }
    main {
      max-width: 900px;
      margin: 0 auto 2rem;
      padding: 0 0.75rem 1.5rem;
    }
    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 0.9rem;
      padding: 0.9rem 0.9rem 0.9rem;
      box-shadow: 0 18px 50px rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.2);
      margin-bottom: 0.9rem;
      backdrop-filter: blur(14px);
    }
    .card h2 {
      margin: 0 0 0.4rem;
      font-size: 1rem;
    }
    .muted {
      color: #9ca3af;
      font-size: 0.8rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.4rem 0.6rem;
      margin-top: 0.4rem;
    }
    label {
      display: block;
      font-size: 0.78rem;
      margin-bottom: 0.15rem;
      color: #9ca3af;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.35rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 0.82rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: none;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.15s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg,#2563eb,#7c3aed);
      color: #f9fafb;
      box-shadow: 0 8px 18px rgba(37,99,235,0.5);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(37,99,235,0.6);
    }
    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.6);
    }
    .btn-secondary:hover {
      background: rgba(30,64,175,0.7);
    }
    .btn-sm { padding: 0.2rem 0.6rem; font-size: 0.76rem; }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .pill {
      border-radius: 999px;
      padding: 0.05rem 0.5rem;
      font-size: 0.75rem;
      background: rgba(30,64,175,0.7);
      color: #e5e7eb;
      border: 1px solid rgba(191,219,254,0.7);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(120px,1fr));
      gap: 0.4rem;
      margin-top: 0.4rem;
    }
    .stat-card {
      background: rgba(15,23,42,0.9);
      border-radius: 0.8rem;
      padding: 0.4rem 0.6rem;
      border: 1px solid rgba(148,163,184,0.35);
    }
    .stat-label {
      font-size: 0.72rem;
      color: #9ca3af;
    }
    .stat-value {
      font-size: 0.95rem;
      margin-top: 0.1rem;
    }
    .stat-note {
      font-size: 0.7rem;
      color: #6b7280;
    }
    .badge {
      border-radius: 999px;
      padding: 0.05rem 0.4rem;
      font-size: 0.72rem;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
    }
    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      border-radius: 0.8rem;
      border: 1px solid rgba(148,163,184,0.5);
      margin-top: 0.4rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
    th, td {
      padding: 0.35rem 0.4rem;
      text-align: left;
      border-bottom: 1px solid rgba(55,65,81,0.8);
      vertical-align: top;
    }
    th {
      position: sticky;
      top: 0;
      background: rgba(15,23,42,0.97);
      z-index: 1;
      text-transform: uppercase;
      font-size: 0.7rem;
      color: #9ca3af;
      letter-spacing: 0.04em;
    }
    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.85);
    }
    .tag {
      border-radius: 999px;
      padding: 0.05rem 0.4rem;
      font-size: 0.72rem;
      border: 1px solid rgba(129,140,248,0.8);
      background: rgba(30,64,175,0.5);
      color: #e5e7eb;
    }
    .error {
      color: #fecaca;
      font-size: 0.78rem;
      margin-top: 0.25rem;
    }
    input[type="file"] {
      font-size: 0.75rem;
    }
    .flex-row {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .nav-bar {
      display:flex;
      gap:0.6rem;
      padding:0.3rem 1rem 0.6rem;
      max-width:900px;
      margin:0 auto;
    }
    .nav-active {
      background: linear-gradient(135deg,#2563eb,#7c3aed);
      color:#f9fafb;
      box-shadow:0 8px 18px rgba(37,99,235,0.5);
      border-color:transparent;
    }
    @media (max-width: 480px) {
      header { flex-direction: column; align-items: flex-start; }
      .table-wrapper { max-height: 300px; }
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Flugmeilen</h1>
    <small>Lokale Web-App &ndash; Daten bleiben auf dem Ger&auml;t</small>
  </div>
  <div class="flex-row">
    <select id="yearSelect" class="badge"></select>
    <button id="resetYearBtn" class="btn btn-secondary btn-sm" type="button">Alle Jahre</button>
  </div>
</header>

<nav class="nav-bar">
  <button id="tabMain"   class="btn btn-secondary btn-sm nav-active">Fl&uuml;ge</button>
  <button id="tabStats"  class="btn btn-secondary btn-sm">Statistik</button>
</nav>

<!-- Seite 1: Fl√ºge / Eingabe -->
<main id="mainPage">
  <!-- Airport Import -->
  <section class="card">
    <div class="toolbar">
      <div>
        <h2>Flughafen-Daten</h2>
        <div class="muted">CSV mit IATA, Stadt, Breite, L&auml;nge aus deinem Excelblatt <b>FlughafenDaten</b> importieren.</div>
      </div>
      <span id="airportCount" class="badge">0 Airports</span>
    </div>
    <div class="form-grid" style="margin-top:0.5rem;">
      <div>
        <label for="airportFile">airports.csv w&auml;hlen</label>
        <input type="file" id="airportFile" accept=".csv,text/csv" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="loadAirportBtn" class="btn btn-secondary btn-sm" type="button">CSV laden</button>
      </div>
      <div style="grid-column:1/-1">
        <div class="muted">
          Erwartete Spaltennamen: <span class="pill">IATA</span>,
          <span class="pill">Stadt</span>,
          <span class="pill">Breite</span>,
          <span class="pill">L&auml;nge</span> (Trennzeichen ; oder ,).
        </div>
      </div>
    </div>
    <div id="airportError" class="error"></div>
  </section>

  <!-- Fl√ºge aus Excel-CSV importieren -->
  <section class="card">
    <div class="toolbar">
      <div>
        <h2>Fl&uuml;ge aus Excel-CSV importieren</h2>
        <div class="muted">
          Pro Jahr ein CSV (z.B. <code>flights_2014.csv</code>) mit Spalten
          <span class="pill">Datum</span>,
          <span class="pill">Von-IATA</span>,
          <span class="pill">Nach-IATA</span>,
          <span class="pill">Airline</span>,
          <span class="pill">Aircraft</span>,
          <span class="pill">Typ (p/g)</span>.
          IATA steht dabei wie in Excel als <code>Z&uuml;rich (ZRH)</code>.
        </div>
      </div>
      <span id="flightImportInfo" class="badge"></span>
    </div>
    <div class="form-grid" style="margin-top:0.5rem;">
      <div>
        <label for="flightsFile">flights_YYYY.csv w&auml;hlen</label>
        <input type="file" id="flightsFile" accept=".csv,text/csv" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="loadFlightsBtn" class="btn btn-secondary btn-sm" type="button">
          Fl&uuml;ge laden
        </button>
      </div>
    </div>
    <div id="flightsImportError" class="error"></div>
  </section>

  <!-- √úbersicht -->
  <section class="card">
    <div class="toolbar">
      <h2>&Uuml;bersicht <span id="summaryYearLabel" class="pill"></span></h2>
      <div class="flex-row">
        <span id="flightCountLabel" class="badge">0 Fl&uuml;ge</span>
      </div>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Miles (Filter)</div>
        <div id="statMiles" class="stat-value">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Km (Filter)</div>
        <div id="statKm" class="stat-value">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Flugzeit (Filter)</div>
        <div id="statHours" class="stat-value">‚Äì</div>
        <div id="statHoursText" class="stat-note"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Fl&uuml;ge p / g (Filter)</div>
        <div id="statPg" class="stat-value">‚Äì</div>
        <div id="statPgNote" class="stat-note">p = privat, g = gesch&auml;ftlich</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Airlines (Filter)</div>
        <div id="statAirlines" class="stat-value">‚Äì</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Aircrafts (Filter)</div>
        <div id="statAircrafts" class="stat-value">‚Äì</div>
      </div>
    </div>
  </section>

  <!-- Mini-Statistik -->
  <section class="card">
    <h2>Mini-Statistik (Filter)</h2>
    <div id="miniStats" class="stats-grid"></div>
  </section>

  <!-- Flug hinzuf√ºgen -->
  <section class="card">
    <h2>Neuen Flug hinzuf&uuml;gen</h2>
    <div class="form-grid">
      <div>
        <label for="flightDate">Datum</label>
        <input type="date" id="flightDate" />
      </div>
      <div>
        <label for="fromIata">Von (IATA)</label>
        <input type="text" id="fromIata" maxlength="3" placeholder="ZRH" />
      </div>
      <div>
        <label for="toIata">Nach (IATA)</label>
        <input type="text" id="toIata" maxlength="3" placeholder="CUN" />
      </div>
      <div>
        <label for="airline">Airline</label>
        <input type="text" id="airline" placeholder="Swiss" />
      </div>
      <div>
        <label for="aircraft">Flugzeugtyp</label>
        <input type="text" id="aircraft" placeholder="Airbus A320" />
      </div>
      <div>
        <label for="tripType">Privat / Gesch&auml;ft</label>
        <select id="tripType">
          <option value="p">Privat</option>
          <option value="g">Gesch&auml;ft</option>
        </select>
      </div>
      <div>
        <label for="speed">√ò Reisegeschwindigkeit [km/h]</label>
        <input type="number" id="speed" value="600" min="300" max="1000" step="10" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="addFlightBtn" class="btn btn-primary" type="button">+ Flug speichern</button>
      </div>
    </div>
    <div id="flightError" class="error"></div>
  </section>

  <!-- Fl√ºge Tabelle -->
  <section class="card">
    <div class="toolbar">
      <div class="flex-row">
        <h2 style="margin:0;">Fl&uuml;ge</h2>
        <span id="visibleCount" class="badge">0 sichtbar</span>
      </div>
      <div class="flex-row">
        <input type="search" id="searchInput" placeholder="Suche (IATA, Stadt, Airline)" />
        <button id="clearAllFlightsBtn" class="btn btn-secondary btn-sm" type="button">Alle l&ouml;schen</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>#</th>
          <th>Datum</th>
          <th>Von</th>
          <th>Nach</th>
          <th>Airline</th>
          <th>Aircraft</th>
          <th>Distanz</th>
          <th>Dauer</th>
          <th>p/g</th>
          <th></th>
        </tr>
        </thead>
        <tbody id="flightTableBody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Seite 2: Statistik -->
<main id="statsPage" style="display:none;">
  <section class="card">
    <h2>üìä Gesamtstatistik (alle Fl&uuml;ge)</h2>
    <div id="statsAllYears" class="stats-grid"></div>
  </section>

  <section class="card">
    <h2>üìÖ Statistik f&uuml;r gew&auml;hltes Jahr</h2>
    <div id="statsSelectedYear" class="stats-grid"></div>
  </section>

  <section class="card">
    <h2>üåç Weltkarte aller Fl&uuml;ge (gew&auml;hltes Jahr / Filter)</h2>
    <div id="map" style="height:350px; border-radius:12px;"></div>
  </section>

  <section class="card">
    <h2>‚úà Flugh&auml;fen</h2>
    <div id="statsAirports"></div>
  </section>

  <section class="card">
    <h2>üõ´ Airlines</h2>
    <div id="statsAirlines"></div>
  </section>

  <section class="card">
    <h2>üõ© Flugzeugtypen</h2>
    <div id="statsAircrafts"></div>
  </section>

  <section class="card">
    <h2>üèÜ Top 5</h2>
    <div class="form-grid">
      <div>
        <h3>Flugh&auml;fen</h3>
        <div id="topAirports"></div>
      </div>
      <div>
        <h3>Airlines</h3>
        <div id="topAirlines"></div>
      </div>
      <div>
        <h3>Flugzeugtypen</h3>
        <div id="topAircrafts"></div>
      </div>
    </div>
  </section>
</main>

<script>
  // neue Keys, damit alte Tests nicht st√∂ren
  const STORAGE_KEY_FLIGHTS = "flugmeilen_flights_v3";
  const STORAGE_KEY_AIRPORTS = "flugmeilen_airports_v3";

  let AIRPORTS = loadAirportsFromStorage();
  let leafletMap = null;

  function loadAirportsFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_AIRPORTS);
      if (!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj === "object" ? obj : {};
    } catch (e) {
      return {};
    }
  }
  function saveAirportsToStorage() {
    localStorage.setItem(STORAGE_KEY_AIRPORTS, JSON.stringify(AIRPORTS));
  }

  function loadFlights() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_FLIGHTS);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch (e) {
      return [];
    }
  }
  function saveFlights(flights) {
    localStorage.setItem(STORAGE_KEY_FLIGHTS, JSON.stringify(flights));
  }

  // ----- Mathe / Format -----
  function deg2rad(deg) { return deg * Math.PI / 180; }

  function calcDistanceKm(fromCode, toCode) {
    const a1 = AIRPORTS[fromCode];
    const a2 = AIRPORTS[toCode];
    if (!a1 || !a2) return null;
    const R = 6371;
    const lat1 = deg2rad(a1.lat), lon1 = deg2rad(a1.lon);
    const lat2 = deg2rad(a2.lat), lon2 = deg2rad(a2.lon);
    const dlat = lat2 - lat1;
    const dlon = lon2 - lon1;
    const h = Math.sin(dlat/2)*Math.sin(dlat/2) +
              Math.cos(lat1)*Math.cos(lat2)*Math.sin(dlon/2)*Math.sin(dlon/2);
    const c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1-h));
    return R * c;
  }

  function calcDurationHours(distanceKm, speedKmh) {
    if (!distanceKm || !speedKmh) return null;
    return distanceKm / speedKmh + 0.5;
  }

  function formatKm(km) {
    if (!km) return "‚Äì";
    return km.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,"'") + " km";
  }

  function formatMiles(km) {
    if (!km) return "‚Äì";
    const miles = km * 0.621371;
    return miles.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,"'") + " mi";
  }

  function formatHours(hours) {
    if (!hours) return "‚Äì";
    const totalMin = Math.round(hours * 60);
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    return String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0") + " h";
  }

  function hoursToText(hours) {
    if (!hours) return "";
    const totalMin = Math.round(hours * 60);
    const d = Math.floor(totalMin / (24*60));
    const remMin = totalMin - d*24*60;
    const h = Math.floor(remMin/60);
    const m = remMin % 60;
    const parts = [];
    if (d) parts.push(d + " Tage");
    if (h) parts.push(h + " Stunden");
    if (m) parts.push(m + " Minuten");
    return parts.join(" ");
  }

  function formatDate(dateStr) {
    if (!dateStr) return "‚Äì";
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr;
    return d.toLocaleDateString();
  }

  // ----- Airports CSV -----
  function parseCsvAirports(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (!lines.length) throw new Error("CSV ist leer.");
    const delimiter = lines[0].includes(";") ? ";" : ",";
    const header = lines[0].split(delimiter).map(h => h.trim());
    const idxIata = header.findIndex(h => h.toLowerCase() === "iata");
    const idxCity = header.findIndex(h => h.toLowerCase() === "stadt");
    const idxLat  = header.findIndex(h => h.toLowerCase() === "breite");
    const idxLon  = header.findIndex(h => h.toLowerCase() === "l\u00e4nge" || h.toLowerCase() === "laenge");
    if (idxIata === -1 || idxCity === -1 || idxLat === -1 || idxLon === -1) {
      throw new Error("Erwartete Spalten IATA, Stadt, Breite, L\u00e4nge nicht gefunden.");
    }
    const result = {};
    for (let i = 1; i < lines.length; i++) {
      const parts = lines[i].split(delimiter);
      if (!parts.length) continue;
      const code = (parts[idxIata] || "").trim().toUpperCase();
      if (!code || code.length !== 3) continue;
      const city = (parts[idxCity] || "").trim();
      const lat = parseFloat((parts[idxLat] || "").replace(",","."));
      const lon = parseFloat((parts[idxLon] || "").replace(",","."));
      if (!isFinite(lat) || !isFinite(lon)) continue;
      result[code] = { city, lat, lon };
    }
    return result;
  }

  function handleAirportCsvLoad() {
    const fileInput = document.getElementById("airportFile");
    const errBox = document.getElementById("airportError");
    errBox.textContent = "";
    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      errBox.textContent = "Bitte eine CSV-Datei ausw\u00e4hlen.";
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const parsed = parseCsvAirports(text);
        AIRPORTS = parsed;
        saveAirportsToStorage();
        updateAirportCount();
        renderAll();
      } catch (err) {
        errBox.textContent = "Fehler beim Einlesen: " + err.message;
      }
    };
    reader.onerror = () => { errBox.textContent = "Fehler beim Lesen der Datei."; };
    reader.readAsText(file, "windows-1252");
  }

  function updateAirportCount() {
    const el = document.getElementById("airportCount");
    const n = Object.keys(AIRPORTS).length;
    el.textContent = n + (n === 1 ? " Airport" : " Airports");
  }

  // ----- Fl√ºge manuell -----
  function addFlight() {
    const date = document.getElementById("flightDate").value;
    const fromIata = document.getElementById("fromIata").value.trim().toUpperCase();
    const toIata = document.getElementById("toIata").value.trim().toUpperCase();
    const airline = document.getElementById("airline").value.trim();
    const aircraft = document.getElementById("aircraft").value.trim();
    const tripType = document.getElementById("tripType").value;
    const speed = Number(document.getElementById("speed").value);
    const errBox = document.getElementById("flightError");
    errBox.textContent = "";

    const errors = [];
    if (!date) errors.push("Datum fehlt.");
    if (!fromIata || fromIata.length !== 3) errors.push("Von-IATA muss 3 Zeichen haben.");
    if (!toIata || toIata.length !== 3) errors.push("Nach-IATA muss 3 Zeichen haben.");
    if (!speed || speed <= 0) errors.push("Geschwindigkeit muss > 0 sein.");
    if (!AIRPORTS[fromIata]) errors.push("Unbekannter Abflugairport: " + fromIata);
    if (!AIRPORTS[toIata]) errors.push("Unbekannter Zielairport: " + toIata);

    if (errors.length) {
      errBox.textContent = errors.join(" ");
      return;
    }

    const distanceKm = calcDistanceKm(fromIata, toIata);
    const durationHours = calcDurationHours(distanceKm, speed);

    const flights = loadFlights();
    const newFlight = {
      id: Date.now(),
      date,
      from: fromIata,
      to: toIata,
      airline,
      aircraft,
      tripType,
      speedKmh: speed,
      distanceKm,
      durationHours
    };
    flights.push(newFlight);
    saveFlights(flights);
    renderAll();
    document.getElementById("airline").value = "";
    document.getElementById("aircraft").value = "";
  }

  function deleteFlight(id) {
    const flights = loadFlights();
    const next = flights.filter(f => String(f.id) !== String(id));
    saveFlights(next);
    renderAll();
  }

  function clearAllFlights() {
    if (!confirm("Alle gespeicherten Fl\u00fcge wirklich l\u00f6schen?")) return;
    localStorage.removeItem(STORAGE_KEY_FLIGHTS);
    renderAll();
  }

  // ----- Fl√ºge aus Excel-CSV (dein Format) -----
  function parseCsvFlights(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (!lines.length) throw new Error("CSV ist leer.");

    const delimiter = lines[0].includes(";") ? ";" : ",";
    const header = lines[0].split(delimiter).map(h => h.trim().toLowerCase());

    const idxDatum   = header.findIndex(h => h === "datum");
    const idxVon     = header.findIndex(h => h === "von-iata");
    const idxNach    = header.findIndex(h => h === "nach-iata");
    const idxAirline = header.findIndex(h => h === "airline");
    const idxAircr   = header.findIndex(h => h === "aircraft");
    const idxTyp     = header.findIndex(h => h === "typ");

    if (idxDatum === -1 || idxVon === -1 || idxNach === -1) {
      throw new Error("Spalten 'Datum', 'Von-IATA' und 'Nach-IATA' m\u00fcssen vorhanden sein.");
    }

    const flights = [];

    function extractIata(s) {
      const m = /\(([A-Za-z]{3})\)$/.exec(s.trim());
      return m ? m[1].toUpperCase() : null;
    }

    for (let i = 1; i < lines.length; i++) {
      const parts = lines[i].split(delimiter);
      if (!parts.length) continue;

      let rawDate = (parts[idxDatum] || "").trim();

      // DD.MM.YYYY -> YYYY-MM-DD
      if (/^\d{2}\.\d{2}\.\d{4}$/.test(rawDate)) {
        const [dd, mm, yyyy] = rawDate.split(".");
        rawDate = `${yyyy}-${mm}-${dd}`;
      } else if (!/^\d{4}-\d{2}-\d{2}$/.test(rawDate)) {
        const d = new Date(rawDate);
        if (!isNaN(d)) {
          const y = d.getFullYear();
          const m = String(d.getMonth()+1).padStart(2,"0");
          const day = String(d.getDate()).padStart(2,"0");
          rawDate = `${y}-${m}-${day}`;
        }
      }

      const fromStr = parts[idxVon]  || "";
      const toStr   = parts[idxNach] || "";
      const from = extractIata(fromStr);
      const to   = extractIata(toStr);
      if (!from || !to) continue;

      const airline  = idxAirline >= 0 ? (parts[idxAirline] || "").trim() : "";
      const aircraft = idxAircr   >= 0 ? (parts[idxAircr]   || "").trim() : "";
      let tripType   = idxTyp     >= 0 ? (parts[idxTyp]     || "").trim().toLowerCase() : "p";
      if (tripType.startsWith("g")) tripType = "g";
      else tripType = "p";

      const distanceKm = calcDistanceKm(from, to);
      const durationHours = distanceKm ? calcDurationHours(distanceKm, 850) : null;

      flights.push({
        id: Date.now() + i,
        date: rawDate,
        from,
        to,
        airline,
        aircraft,
        tripType,
        speedKmh: 850,
        distanceKm,
        durationHours
      });
    }

    return flights;
  }

  function handleFlightsCsvLoad() {
    const fileInput = document.getElementById("flightsFile");
    const errBox    = document.getElementById("flightsImportError");
    const infoBox   = document.getElementById("flightImportInfo");
    errBox.textContent = "";
    infoBox.textContent = "";

    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      errBox.textContent = "Bitte eine Flights-CSV ausw\u00e4hlen.";
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const imported = parseCsvFlights(text);

        if (!imported.length) {
          errBox.textContent = "Keine g\u00fcltigen Fl\u00fcge in der CSV gefunden.";
          return;
        }

        const existing = loadFlights();
        const all = existing.concat(imported);
        saveFlights(all);
        infoBox.textContent = imported.length + " Fl\u00fcge importiert.";
        renderAll();
      } catch (err) {
        errBox.textContent = "Fehler beim Einlesen: " + err.message;
      }
    };
    reader.onerror = () => {
      errBox.textContent = "Fehler beim Lesen der Datei.";
    };
    reader.readAsText(file, "windows-1252");
  }

  // ----- Filter / Jahr / Suche -----
  function getSelectedYear() {
    const val = document.getElementById("yearSelect").value;
    return val === "" ? null : Number(val);
  }

  function buildYearOptions(flights) {
    const years = new Set();
    for (const f of flights) {
      if (!f.date) continue;
      const y = new Date(f.date).getFullYear();
      if (!isNaN(y)) years.add(y);
    }
    const arr = Array.from(years).sort((a,b)=>a-b);
    const sel = document.getElementById("yearSelect");
    const current = sel.value;
    sel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "Alle Jahre";
    sel.appendChild(optAll);
    for (const y of arr) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = y;
      sel.appendChild(opt);
    }
    if (current) sel.value = current;
  }

  function applyFilters(flights) {
    const year = getSelectedYear();
    const search = document.getElementById("searchInput").value.trim().toLowerCase();
    let filtered = flights;
    if (year) {
      filtered = filtered.filter(f => {
        const d = new Date(f.date);
        return !isNaN(d) && d.getFullYear() === year;
      });
    }
    if (search) {
      filtered = filtered.filter(f => {
        const aFrom = AIRPORTS[f.from] || {};
        const aTo = AIRPORTS[f.to] || {};
        const hay = [
          f.from, f.to,
          aFrom.city, aTo.city,
          f.airline, f.aircraft
        ].filter(Boolean).join(" ").toLowerCase();
        return hay.includes(search);
      });
    }
    return filtered;
  }

  // ----- Statistik-Helfer -----
  function countOccurrences(array, keyFn) {
    const map = {};
    array.forEach(item => {
      const key = keyFn(item);
      if (!key) return;
      map[key] = (map[key] || 0) + 1;
    });
    return map;
  }

  function sortedEntries(obj) {
    return Object.entries(obj).sort((a,b)=>b[1]-a[1]);
  }

  function buildStatsTable(entries) {
    if (!entries.length) return "<span class=\"muted\">Keine Daten</span>";
    let html = "<table><tbody>";
    entries.forEach(([name,count])=>{
      html += "<tr><td>"+name+"</td><td style=\"text-align:right;\">"+count+"</td></tr>";
    });
    html += "</tbody></table>";
    return html;
  }

  function getMapSegments(flights) {
    const segments = [];
    flights.forEach(f => {
      const a1 = AIRPORTS[f.from];
      const a2 = AIRPORTS[f.to];
      if (a1 && a2) segments.push([[a1.lat, a1.lon],[a2.lat,a2.lon]]);
    });
    return segments;
  }

  function renderMap(flights) {
  if (!document.getElementById("map")) return;

  // vorhandene Karte entfernen
  if (leafletMap) {
    leafletMap.remove();
    leafletMap = null;
  }

  // neue Karte anlegen
  leafletMap = L.map("map").setView([20, 0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 8
  }).addTo(leafletMap);

  // alle Airports aus den Fl√ºgen einsammeln (ein Punkt pro Airport)
  const airportCodes = new Set();
  flights.forEach(f => {
    if (AIRPORTS[f.from]) airportCodes.add(f.from);
    if (AIRPORTS[f.to])   airportCodes.add(f.to);
  });

  const bounds = [];
  airportCodes.forEach(code => {
    const a = AIRPORTS[code];
    if (!a) return;
    const latlng = [a.lat, a.lon];

    // normaler Marker mit Popup Stadt (IATA)
    L.marker(latlng)
      .addTo(leafletMap)
      .bindPopup((a.city || code) + " (" + code + ")");

    bounds.push(latlng);
  });

  // Karte auf alle Punkte zoomen
  if (bounds.length) {
    leafletMap.fitBounds(bounds, { padding: [20, 20] });
  }
}


  function renderFullStatistics() {
    const flights = loadFlights();
    const year = getSelectedYear();
    const flightsYear = year
      ? flights.filter(f => { const d = new Date(f.date); return !isNaN(d)&&d.getFullYear()===year; })
      : flights;

    const totalKmAll = flights.reduce((s,f)=>s+(f.distanceKm||0),0);
    const totalHoursAll = flights.reduce((s,f)=>s+(f.durationHours||0),0);
    const allAirportsSet = new Set();
    flights.forEach(f=>{
      if (AIRPORTS[f.from]) allAirportsSet.add(f.from);
      if (AIRPORTS[f.to])   allAirportsSet.add(f.to);
    });
    const allAirlinesSet = new Set(flights.map(f=> (f.airline||"").trim()).filter(Boolean));
    const allAircraftSet = new Set(flights.map(f=> (f.aircraft||"").trim()).filter(Boolean));

    document.getElementById("statsAllYears").innerHTML =
      "<div class=\"stat-card\"><div class=\"stat-label\">Total Km</div><div class=\"stat-value\">"+totalKmAll.toLocaleString()+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Total Miles</div><div class=\"stat-value\">"+Math.round(totalKmAll*0.621371).toLocaleString()+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Total Zeit</div><div class=\"stat-value\">"+formatHours(totalHoursAll)+"</div><div class=\"stat-note\">"+hoursToText(totalHoursAll)+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Fl\u00fcge</div><div class=\"stat-value\">"+flights.length+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Different Airports</div><div class=\"stat-value\">"+allAirportsSet.size+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Different Airlines</div><div class=\"stat-value\">"+allAirlinesSet.size+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Different Aircrafts</div><div class=\"stat-value\">"+allAircraftSet.size+"</div></div>";

    const totalKmYear = flightsYear.reduce((s,f)=>s+(f.distanceKm||0),0);
    const totalHoursYear = flightsYear.reduce((s,f)=>s+(f.durationHours||0),0);
    document.getElementById("statsSelectedYear").innerHTML =
      "<div class=\"stat-card\"><div class=\"stat-label\">Jahr</div><div class=\"stat-value\">"+(year ?? "Alle")+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Km</div><div class=\"stat-value\">"+totalKmYear.toLocaleString()+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Miles</div><div class=\"stat-value\">"+Math.round(totalKmYear*0.621371).toLocaleString()+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Zeit</div><div class=\"stat-value\">"+formatHours(totalHoursYear)+"</div><div class=\"stat-note\">"+hoursToText(totalHoursYear)+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Fl\u00fcge</div><div class=\"stat-value\">"+flightsYear.length+"</div></div>";

    const airportFrom = countOccurrences(flightsYear, f => {
      const a = AIRPORTS[f.from];
      return a ? (a.city || f.from) + " (" + f.from + ")" : null;
    });
    const airportTo = countOccurrences(flightsYear, f => {
      const a = AIRPORTS[f.to];
      return a ? (a.city || f.to) + " (" + f.to + ")" : null;
    });
    const mergedAirports = {};
    for (const [k,v] of Object.entries(airportFrom)) mergedAirports[k] = (mergedAirports[k]||0)+v;
    for (const [k,v] of Object.entries(airportTo)) mergedAirports[k] = (mergedAirports[k]||0)+v;
    const sortedAirports = sortedEntries(mergedAirports);

    const airlinesCounts = countOccurrences(flightsYear, f => (f.airline||"").trim() || null);
    const sortedAirlines = sortedEntries(airlinesCounts);

    const aircraftCounts = countOccurrences(flightsYear, f => (f.aircraft||"").trim() || null);
    const sortedAircrafts = sortedEntries(aircraftCounts);

    document.getElementById("statsAirports").innerHTML  = buildStatsTable(sortedAirports);
    document.getElementById("statsAirlines").innerHTML  = buildStatsTable(sortedAirlines);
    document.getElementById("statsAircrafts").innerHTML = buildStatsTable(sortedAircrafts);

    document.getElementById("topAirports").innerHTML  = buildStatsTable(sortedAirports.slice(0,5));
    document.getElementById("topAirlines").innerHTML  = buildStatsTable(sortedAirlines.slice(0,5));
    document.getElementById("topAircrafts").innerHTML = buildStatsTable(sortedAircrafts.slice(0,5));

    setTimeout(()=>renderMap(flightsYear),100);
  }

  // ----- Rendering Hauptseite -----
  function renderFlightsTable(visibleFlights) {
    const tbody = document.getElementById("flightTableBody");
    tbody.innerHTML = "";
    visibleFlights.forEach((f, idx) => {
      const tr = document.createElement("tr");
      const fromA = AIRPORTS[f.from] || {};
      const toA = AIRPORTS[f.to] || {};
      tr.innerHTML =
        "<td>"+(idx+1)+"</td>"+
        "<td>"+formatDate(f.date)+"</td>"+
        "<td><div><span class=\"tag\">"+f.from+"</span></div><div class=\"muted\">"+(fromA.city || "")+"</div></td>"+
        "<td><div><span class=\"tag\">"+f.to+"</span></div><div class=\"muted\">"+(toA.city || "")+"</div></td>"+
        "<td>"+(f.airline || "‚Äì")+"</td>"+
        "<td>"+(f.aircraft || "‚Äì")+"</td>"+
        "<td>"+formatKm(f.distanceKm)+"<br><span class=\"muted\">"+formatMiles(f.distanceKm)+"</span></td>"+
        "<td>"+formatHours(f.durationHours)+"</td>"+
        "<td>"+(f.tripType || "‚Äì")+"</td>"+
        "<td><button class=\"btn btn-secondary btn-sm\" data-id=\""+f.id+"\">‚úï</button></td>";
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("button[data-id]").forEach(btn => {
      btn.addEventListener("click", () => {
        deleteFlight(btn.getAttribute("data-id"));
      });
    });
    document.getElementById("visibleCount").textContent =
      visibleFlights.length + " sichtbar";
  }

  function renderSummary(flights, visibleFlights) {
    const year = getSelectedYear();
    document.getElementById("summaryYearLabel").textContent = year ? year : "Alle Jahre";

    const statMilesEl = document.getElementById("statMiles");
    const statKmEl = document.getElementById("statKm");
    const statHoursEl = document.getElementById("statHours");
    const statHoursTextEl = document.getElementById("statHoursText");
    const statPgEl = document.getElementById("statPg");
    const statAirlinesEl = document.getElementById("statAirlines");
    const statAircraftsEl = document.getElementById("statAircrafts");
    const flightCountLabel = document.getElementById("flightCountLabel");

    const totalKm = visibleFlights.reduce((s,f)=> s + (f.distanceKm||0), 0);
    const totalHours = visibleFlights.reduce((s,f)=> s + (f.durationHours||0), 0);
    const totalFlights = visibleFlights.length;
    const priv = visibleFlights.filter(f=>f.tripType==="p").length;
    const gesch = visibleFlights.filter(f=>f.tripType==="g").length;

    const airlines = new Set(visibleFlights.map(f => (f.airline||"").trim()).filter(Boolean));
    const aircrafts = new Set(visibleFlights.map(f => (f.aircraft||"").trim()).filter(Boolean));

    statKmEl.textContent = totalKm ? formatKm(totalKm) : "‚Äì";
    statMilesEl.textContent = totalKm ? formatMiles(totalKm) : "‚Äì";
    statHoursEl.textContent = totalHours ? formatHours(totalHours) : "‚Äì";
    statHoursTextEl.textContent = totalHours ? hoursToText(totalHours) : "";
    statPgEl.textContent = totalFlights ? (totalFlights+" (p: "+priv+", g: "+gesch+")") : "‚Äì";
    statAirlinesEl.textContent = airlines.size ? (""+airlines.size) : "‚Äì";
    statAircraftsEl.textContent = aircrafts.size ? (""+aircrafts.size) : "‚Äì";
    flightCountLabel.textContent = totalFlights + (totalFlights === 1 ? " Flug" : " Fl\u00fcge");
  }

  function renderMiniStats(visibleFlights) {
    const miniKm = visibleFlights.reduce((s,f)=>s+(f.distanceKm||0),0);
    const miniHours = visibleFlights.reduce((s,f)=>s+(f.durationHours||0),0);
    document.getElementById("miniStats").innerHTML =
      "<div class=\"stat-card\"><div class=\"stat-label\">Km</div><div class=\"stat-value\">"+miniKm.toLocaleString()+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Meilen</div><div class=\"stat-value\">"+Math.round(miniKm*0.621371).toLocaleString()+"</div></div>"+
      "<div class=\"stat-card\"><div class=\"stat-label\">Zeit</div><div class=\"stat-value\">"+formatHours(miniHours)+"</div></div>";
  }

  function renderAll() {
    updateAirportCount();
    const flights = loadFlights();
    buildYearOptions(flights);
    const visible = applyFilters(flights);
    renderFlightsTable(visible);
    renderSummary(flights, visible);
    renderMiniStats(visible);
    if (document.getElementById("statsPage").style.display !== "none") {
      renderFullStatistics();
    }
  }

  // ----- Init -----
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("loadAirportBtn").addEventListener("click", handleAirportCsvLoad);
    document.getElementById("loadFlightsBtn").addEventListener("click", handleFlightsCsvLoad);
    document.getElementById("addFlightBtn").addEventListener("click", addFlight);
    document.getElementById("clearAllFlightsBtn").addEventListener("click", clearAllFlights);
    document.getElementById("searchInput").addEventListener("input", renderAll);
    document.getElementById("yearSelect").addEventListener("change", renderAll);
    document.getElementById("resetYearBtn").addEventListener("click", () => {
      document.getElementById("yearSelect").value = "";
      renderAll();
    });

    const tabMain = document.getElementById("tabMain");
    const tabStats = document.getElementById("tabStats");
    const mainPage = document.getElementById("mainPage");
    const statsPage = document.getElementById("statsPage");

    tabMain.addEventListener("click", () => {
      mainPage.style.display = "block";
      statsPage.style.display = "none";
      tabMain.classList.add("nav-active");
      tabStats.classList.remove("nav-active");
      renderAll();
    });

    tabStats.addEventListener("click", () => {
      mainPage.style.display = "none";
      statsPage.style.display = "block";
      tabStats.classList.add("nav-active");
      tabMain.classList.remove("nav-active");
      renderFullStatistics();
    });

    renderAll();
  });
</script>
</body>
</html>
